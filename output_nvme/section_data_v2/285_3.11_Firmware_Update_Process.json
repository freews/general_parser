{
  "section_index": 285,
  "section_id": "3.11",
  "title": "3.11 Firmware Update Process",
  "level": 2,
  "pages": {
    "start": 156,
    "end": 158,
    "count": 3
  },
  "content": {
    "text": "The process for a firmware update to be activated in a domain (refer to section 3.2.5) by a reset is:\n1. The host issues a Firmware Image Download command to download the firmware image to a\ncontroller. There may be multiple portions of the firmware image to download, thus the offset for\neach portion of the firmware image being downloaded on that controller is specified in the Firmware\nImage Download command. The data provided in the Firmware Image Download command should\nconform to the Firmware Update Granularity indicated in the Identify Controller data structure or\nthe firmware update may fail;\n2. After the firmware is downloaded to that controller, the next step is for the host to submit a Firmware\nCommit command to that controller. The Firmware Commit command verifies that the last firmware\nimage downloaded is valid and commits that firmware image to the firmware slot indicated for future\nuse. A firmware image that does not start at offset zero, contains gaps, or contains overlapping\nregions is considered invalid. A controller may employ additional vendor specific means (e.g.,\nchecksum, CRC, cryptographic hash, or a digital signature) to determine the validity of a firmware\nimage:\na. The Firmware Commit command may also be used to activate a firmware image associated\nwith a previously committed firmware slot;\n3. The host performs an action that results in a Controller Level Reset (refer to section 3.7.2) on that\ncontroller to cause the firmware image specified in the Firmware Slot field in the Firmware Commit\ncommand to be activated:\na. In some cases, a Conventional Reset (refer to the NVMe over PCIe Transport Specification) or\nNVM Subsystem Reset is required to activate a firmware image. This requirement is indicated\nby Firmware Commit command specific status (refer to section 5.2.8.1);\nand\n4. After the reset has completed, the host re-initializes the controller. This includes re-allocating I/O\nSubmission and Completion Queues. Refer to sections 3.5.1 and 3.5.2.\nThe process for a firmware update to be activated on a domain without a reset is:\n1. The host issues a Firmware Image Download command to download the firmware image to a\ncontroller. There may be multiple portions of the firmware image to download, thus the offset for\neach portion of the firmware image being downloaded on that controller is specified in the Firmware\nImage Download command. The data provided in the Firmware Image Download command should\nconform to the Firmware Update Granularity indicated in the Identify Controller data structure or\nthe firmware update may fail;\n2. The host submits a Firmware Commit command on that controller with a Commit Action of 011b\nwhich specifies that the firmware image should be activated immediately without reset. The\ndownloaded firmware image shall replace the firmware image in the firmware slot. If no firmware\nimage was downloaded since the last reset or Firmware Commit command, (i.e., the first step was\nskipped), then that controller shall verify and activate the firmware image in the specified slot. If\nthat controller starts to activate the firmware image, any controllers affected by the new firmware\nimage send a Firmware Activation Starting asynchronous event to the host if Firmware Activation\nNotices are enabled (refer to Figure 409):\na. The Firmware Commit command may also be used to activate a firmware image associated\nwith a previously committed firmware slot;\n3. The controller completes the Firmware Commit command. The following actions are taken in\ncertain error scenarios:\na. If the firmware image is invalid, then the controller aborts the command with an appropriate\nstatus code (e.g., Invalid Firmware Image);\nb. If the firmware activation was not successful because a Controller Level Reset is required to\nactivate this firmware image, then the controller aborts the command with a status code of\nFirmware Activation Requires Controller Level Reset and the firmware image is applied at the\nnext Controller Level Reset;\nc. If the firmware activation was not successful because an NVM Subsystem Reset is required to\nactivate this firmware image, then the controller aborts the command with a status code of\nFirmware Activation Requires NVM Subsystem Reset and the firmware image is applied at the\nnext NVM Subsystem Reset;\nd. If the firmware activation was not successful because a Conventional Reset is required to\nactivate this firmware image, then the controller aborts the command with a status code of\nFirmware Activation Requires Conventional Reset and the firmware image is applied at the\nnext Conventional Reset; and\ne. If the firmware activation was not successful because the firmware activation time requires\nmore time than the time reported by the MTFA field in the Identify Controller data structure,\nthen the controller aborts the command with a status code of Firmware Activation Requires\nMaximum Time Violation. In this case, the firmware image was committed to the specified\nfirmware slot. To activate that firmware image, the host may issue a Firmware Commit\ncommand that specifies:\ni. a Commit Action set to 010b (i.e., activate using a Controller Level Reset); and\nii. the same firmware slot.\nIf the controller transitions to the D3cold state (refer to the PCI Express Base Specification) after the\nsubmission of a Firmware Commit command that attempts to activate a firmware image and before the\ncompletion of that command, then the controller may resume operation with either the firmware image\nactive at the time the Firmware Commit command was submitted or the firmware image that was activated\nby that command.\nIf the firmware image is not able to be successfully loaded, then the controller shall revert to the firmware\nimage present in the most recently activated firmware slot or the baseline read-only firmware image, if\navailable, and indicate the failure as an asynchronous event with a Firmware Image Load Error. If the\ncontroller changes (e.g., reverts) the firmware image while a sanitize operation is in progress, then that\nsanitize operation fails (refer to section 8.1.26.4).\nIf a host overwrites (i.e., updates) the firmware image in the active firmware slot, then the previously active\nfirmware image may no longer be available. As a result, any action (e.g., power cycling the controller) that\nrequires the use of that firmware slot may instead use the firmware image that is currently in that firmware\nslot. If the firmware image that is currently in that firmware slot would be activated by such an action\nreplacing the currently active firmware, then:\n•\nthis is a pending firmware activation with reset; and\n•\na controller aborts subsequent:\no\nSanitize commands or Sanitize Namespace commands with a status code indicating the\nappropriate reset required to activate the pending activation as defined in section 5.2.22;\nand\no\nSet Features commands requesting to change the settings of the specified personality as\ndefined in section 8.1.6.1.\nA host should not overlap firmware/boot partition image update command sequences (refer to section\n1.5.42). During a firmware image update command sequence, if a Firmware Image Download command or\na Firmware Commit command is submitted for another firmware/boot partition image update command\nsequence, the results of both that command and the in-progress firmware image update are undefined.\nA host should use the same controller or Management Endpoint (refer to the NVM Express Management\nInterface Specification) for all commands that are part of a firmware image update command sequence. If\nthe commands for a single firmware/boot partition image update command sequence are submitted to more\nthan one controller and/or Management Endpoint, the controller may abort the Firmware Commit command\nwith Invalid Firmware Image status.\nAfter downloading a firmware image, a host issues a Firmware Commit command before downloading\nadditional firmware images. Processing of the first Firmware Image Download command after completion\nof a Firmware Commit command shall cause the controller to discard remaining portions, if any, of\ndownloaded images. If a reset occurs between a firmware download and completion of the Firmware\nCommit command, then the controller shall discard all portion(s), if any, of downloaded images.",
    "tables": [],
    "figures": []
  },
  "statistics": {
    "table_count": 0,
    "figure_count": 0
  }
}