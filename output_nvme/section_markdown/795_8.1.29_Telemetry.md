#### 8.1.29 Telemetry

> **Section ID**: 8.1.29 | **Page**: 675-677

Telemetry enables manufacturers to collect internal data logs to improve the functionality and reliability of
products. The telemetry data collection may be initiated by the host or by the controller. The data is returned
in the Telemetry Host-Initiated log page or the Telemetry Controller-Initiated log page (refer to section
5.2.12.1.8 and 5.2.12.1.9). The data captured is vendor specific. The telemetry feature defines the
mechanism to collect the vendor specific data. The controller indicates support for the telemetry log pages
and for the Data Area 4 size in the Log Page Attributes (LPA) field in the Identify Controller data structure
(refer to Figure 328).
An important aspect to discovering issues by collecting telemetry data is the ability to qualify distinct issues
that are being collected. The ability to create a one to one mapping of issues to data collections is essential.
If a one to one mapping is not established, there is the risk that several payload collections appear distinct
but are actually all caused by the same issue. Conversely, a single payload collection may have payloads
caused by several issues mixed together creating additional complexity in determining the root cause. As
a result, flexibility in size is provided in the collection of telemetry payloads and a three phase process is
typically used.
The first phase establishes that an issue exists and is best accomplished by collecting a minimum set of
data to identify the issue as being distinct from other issues. Once the number of instances of an issue
establish an investigation, another phase may be necessary to collect actionable information. In the second
phase, a targeted collection of more in depth medium size payloads are gathered and analyzed to identify
the source of the problem.
If the small or medium sized telemetry data collection provides insufficient information, a third phase may
be employed to collect additional details. If the Data Area 4 Support (DA4S) bit is cleared to ‘0’ in the Log
Page Attributes field, then the third phase provides the largest and most complete payload to diagnose the
issue. If the DA4S bit is set to ‘1’ and the Extended Telemetry Data Area 4 Supported (ETDAS) field is set
to 1h in the Host Behavior Support feature (refer to section 5.2.26.1.14) then a fourth phase may be
employed to collect the largest and most complete payload to diagnose the issue. If Data Area 4 is created,
then Data Area 3 of non-zero length shall also be created and populated as part of data collection.
There are two telemetry data logs (i.e., Telemetry Host-Initiated log page and Telemetry Controller-Initiated
log page) defined. Each telemetry data log is made up of a single set of Telemetry Data Blocks. Each
Telemetry Data Block is 512 bytes in size. Telemetry data is returned (refer to section 5.2.12.1.8 and section
5.2.12.1.9) in units of Telemetry Data Blocks. Each telemetry data log is segmented into:
a) Three Telemetry Data Areas (i.e., small, medium, and large), if the DA4S bit is cleared to ‘0’; or
b) Four Telemetry Data Areas (i.e., small, medium, large and extra-large) If the DA4S bit is set to ‘1’
and the Extended Telemetry Data Area 4 Supported (ETDAS) field is set to 1h in the Host Behavior
Support feature (refer to section 5.2.26.1.14).
All telemetry data areas start at Telemetry Data Block 1.
Each Telemetry Data Area shall represent the controller’s internal state at the time the telemetry data was
captured.
Each Telemetry Data Area is intended to capture a richer set of data to aid in resolution of issues. Telemetry
Data Area 1 is intended to have a small size payload (i.e., the first phase), Telemetry Data Area 2 is intended
to have a medium size payload (i.e., the second phase), and Telemetry Data Area 3 is intended to have a
large size payload (i.e., the third phase). Telemetry Data Area 4 is intended to have an extra-large size
payload (i.e., the fourth phase). The size of each Telemetry Data Area is vendor specific and may change
on each data collection. When possible, the host should retrieve the payload for all supported Telemetry
Data Areas to enable the best diagnosis of the issue(s).
The preparation, collection, and submission of telemetry data is similar for host-initiated and controller-
initiated data; the primary difference is the trigger for the collection. The operational model for telemetry is:
1. The host identifies controller support for Telemetry log pages in the Identify Controller data
structure;
2. The host may indicate the support for the Telemetry Host-Initiated Data Area 4 and Telemetry
Controller-Initiated Data Area 4 by setting the Extended Telemetry Data Area 4 Supported (ETDAS)
field to 1h in the Host Behavior Support feature (refer to section 5.2.26.1.14);
3. The host prepares an area to store telemetry data if needed;
4. To receive notification that controller-initiated telemetry data is available, the host enables
Telemetry Log Notices using the Asynchronous Event Configuration feature (refer to section
5.2.26.1.5); and
5. If the host decides to collect host-initiated telemetry data or the controller signals that controller-
initiated telemetry data is available:
a. The host reads the appropriate blocks of the Telemetry Data Area from the Telemetry Host-
Initiated log page (refer to section 5.2.12.1.8) or the Telemetry Controller-Initiated log page
(refer to section 5.2.12.1.9). If possible, the host should collect Telemetry Data Area 1, 2, 3,
and 4. The host reads the log in 512 byte Telemetry Data Block units (i.e., a starting offset that
is a multiple of 512, and a length that is a multiple of 512). The host should set the Retain
Asynchronous Event bit to ‘1’;
b. The host re-reads the header of the log page and ensures that the Telemetry Host-Initiated
Data Generation Number field from the Telemetry Host-Initiated log page or the Telemetry
Controller-Initiated Data Generation Number field in the Telemetry Controller-Initiated log page
matches the original value read. If these values do not match, then the data captured is not
consistent and should be re-read from the log page with the Retain Asynchronous Event bit set
to ‘1’;
c. If the host is reading the controller-initiated log, then the host ensures that the Telemetry
Controller-Initiated Data Available field is still set to 1h after reading the appropriate blocks of
the Telemetry Data Area because the Telemetry Controller-Initiated Data Available field may
have been cleared to 0h by another entity while the log page was being read;
d. If the host is reading the Telemetry Controller-Initiated log page, then the host reads any portion
of that log page with the Retain Asynchronous Event bit cleared to ‘0’ to indicate to the controller
that the host has completed reading the Telemetry Controller-Initiated log page; and
e. When all telemetry data has been saved, the data should be forwarded to the manufacturer of
the controller.
The trigger for the collection for host-initiated data is typically a system crash, but may also be initiated
during normal operation. The host proceeds with a host-initiated data collection by submitting the Get Log
Page command for the Telemetry Host-Initiated log page with the Create Telemetry Host-Initiated Data bit
set to ‘1’ in the Log Specific Parameter field. The controller should complete the command quickly (e.g., in
less than one second) to avoid a user rebooting the system prior to completion of the data collection.
The NVM subsystem is allowed to provide a Telemetry Host-Initiated log page per controller or a shared
Telemetry Host-Initiated log page across all controllers in the NVM subsystem. If a shared Telemetry Host-
Initiated log page is implemented, the Telemetry Host-Initiated Data Generation Number field in the
Telemetry Host-Initiated log page is used to allow the host to detect that the Telemetry Host-Initiated log
page has been changed by:
•
a host through a different controller; or
•
a Management Controller through a Management Endpoint (refer to the NVM Express
Management Interface Specification).
The controller notifies the host to collect controller-initiated data through the completion of an Asynchronous
Event Request command with an Asynchronous Event Type of Notice that indicates a Telemetry Log
Changed event. The host may also determine controller-initiated data is available via the Telemetry
Controller-Initiated Data Available field in the Telemetry Host-Initiated or the Telemetry Controller-Initiated
log pages. The host proceeds with a controller-initiated data collection by submitting the Get Log Page
command for the Telemetry Controller-Initiated log page. Once the host has started reading the Telemetry
Controller-Initiated log page, the controller should avoid modifying the controller-initiated data until the host
has finished reading all controller-initiated data. The amount of time for the host to read the controller-
initiated data is vendor specific.
Since there is only one set of controller-initiated data, the controller is responsible for prioritizing the version
of the controller-initiated data that is available for the host to collect. When the controller replaces the
controller-initiated data with new controller-initiated data, the controller shall increment the Telemetry
Controller-Initiated Data Generation Number field. The host needs to ensure that the Telemetry Controller-
Initiated Data Generation Number field has not changed between the start and completion of the controller-
initiated data collection to ensure the data captured is consistent.
