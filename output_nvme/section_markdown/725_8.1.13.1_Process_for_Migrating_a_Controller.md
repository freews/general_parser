##### 8.1.13.1 Process for Migrating a Controller

> **Section ID**: 8.1.13.1 | **Page**: 601-603

This section provides an example sequence of steps to allow the MMHS to migrate a Migratable Controller
in the Source NVM Subsystem and the attached namespaces to a Migratable Controller in the Destination
NVM Subsystem (refer to Figure 667). Additionally, the steps include obtaining the host memory
modifications made to the host due to the Migratable Controller in the Source NVM Subsystem processing
commands during the migration.
In this example the MMC in the Source NVM Subsystem has:
•
the Track User Data Changes Support (TUDCS) bit set to ‘1’ in the Tracking Attributes (TRATTR)
field in the Identify Controller data structure (refer to Figure 328); and
•
the Track Host Memory Changes Support (THMCS) bit set to ‘1’ in the Tracking Attributes
(TRATTR) field in the Identify Controller data structure.
If attached namespaces are not required to be migrated by the MMHS, then those steps may be ignored.
If host memory modifications are not required to be obtained by the MMHS, then those steps may be
ignored.
1. The MMHS copies (i.e., migrates) the user data in namespaces attached to the Migratable
Controller in the Source NVM Subsystem while the host is submitting commands and the
Migratable Controller is processing those submitted commands.
a. The MMHS creates a User Data Migration Queue in the MMC in the Source NVM Subsystem
by submitting a Controller Data Queue command to that MMC (refer to section 5.2.4)
specifying:
•
the Select field set to the Create Controller Data Queue (i.e., 0h);
•
the Queue Type field set to User Data Migration Queue; and
•
the Controller Identifier field (refer to Figure 170) set to the controller identifier for the
Migratable Controller in the Source NVM Subsystem.
b. If the Controller Data Queue command is successful, the completion queue entry contains the
Controller Data Queue Identifier for the created User Data Migration Queue. The MMHS
causes the MMC in the Source NVM Subsystem to post user data modifications to namespaces
attached to the Migratable Controller by submitting a Track Send command (refer to section
5.2.28) to that MMC specifying:
•
the Select field set to Log User Data Changes (i.e., 0h);
•
the Logging Action bit set to ‘1’ (i.e., start logging); and
•
the Controller Data Queue Identifier field set to the Controller Data Queue Identifier from
the completion queue entry for the Controller Data Queue command.
It is the responsibility of the MMHS to make sure that the User Data Migration Queue is sized
properly and there may be more restrictions on that MMHS as specified by the appropriate I/O
command set (e.g., the NVM Command Set requires the MMHS to not allow the User Data
Migration Queue to become full). Refer to section 8.1.7 for a description of the User Data
Migration Queue (i.e., a Controller Data Queue).
g
(
,
)
c. If the Track Send command is successful, then the MMHS starts copying the namespaces
attached to the Migratable Controller in the Source NVM Subsystem to the Destination NVM
Subsystem. Refer to the applicable NVM Express I/O Command Set specifications for
capabilities that may reduce the amount of user data that is required to copied (e.g., the Get
LBA Status command in the NVM Express NVM Command Set Specification).
2. The MMHS causes the MMC in the Source NVM Subsystem to start tracking the modifications to
host memory in the host due to the Migratable Controller processing submitted commands.
a. The MMHS submits a Track Send command to the MMC in the Source NVM Subsystem (refer
to section 5.2.28) specifying:
•
the Select field set to the Track Memory Changes (i.e., 1h);
•
the Tracking Action (TACT) bit set to ‘1’;
•
the Controller Identifier field specifying the identifier for the Migratable Controller in the
Source NVM Subsystem being migrated; and
•
a Track Memory Changes data structure in the data buffer specifying the host memory to
be tracked as described by the set of host memory ranges.
b. If the Track Send command is successful, then the MMHS may query the host memory
modifications that have resulted from the Migratable Controller processing commands by
submitting a Track Receive command (refer to section 5.2.27) to the MMC in the Source NVM
Subsystem specifying:
•
the Select field set to the Track Memory Changes (i.e., 0h); and
•
the Controller Identifier field specifying the identifier for the Migratable Controller in the
Source NVM Subsystem being migrated.
3. Once the MMHS has copied the namespaces attached to the Migratable Controller in the Source
NVM Subsystem, that MMHS determines a time to suspend that Migratable Controller. During this
period, that MMHS is migrating the user data in the namespaces attached to that Migratable
Controller that are identified in the posted entries in the User Data Migration Queue. That MMHS
may handle the modified host memory in the host as reported by the Track Receive command.
y
y
p
y
4. The MMHS suspends the Migratable Controller in the Source NVM Subsystem by submitting a
Migration Send command to the MMC in the Source NVM Subsystem specifying:
•
the Select field set to the Suspend (i.e., 0h);
•
the Suspend Type field set to Suspend (i.e., 1h);
•
Delete User Data Migration Queue bit set to ‘1’, if the MMHS desires that the MMC delete
the User Data Migration Queue being used to log user data changes of the Migratable
Controller being migrated; and
•
the Controller Identifier field (refer to Figure 367) set to the controller identifier for the
Migratable Controller to be suspended (i.e., the Migratable Controller being migrated).
Prior to completing that Migration Send command:
•
the specified Migratable Controller being suspended:
o
stops fetching commands (i.e.; from the Admin queue and I/O queues); and
o
completes all previously fetched commands;
and
•
the MMC processing that Migration Send command:
o
if user data is being logged into a User Data Migration Queue that is associated with
the Migratable Controller being migrated, an entry is placed into the User Data
Migration Queue that indicates the user data logging has suspended, and then deletes
the User Data Migration Queue, if the Delete User Data Migration Queue bit is set to
‘1’
5. Since the Migratable Controller in the Source NVM Subsystem is suspended, the MMHS migrates
the user data in the namespaces attached to the Migratable Controller that are identified in the
posted entries in the User Data Migration Queue. Refer to the applicable NVM Express I/O
Command Set specification to determine how the entries identify when entries have completed
being posted. That MMHS may handle the modified host memory in the host as reported by the
Track Receive command.
6. The MMHS is able to obtain the controller state of the Migratable Controller in the Source NVM
Subsystem by submitting one or more Migration Receive commands to the MMC in the Source
NVM Subsystem specifying:
a. the Select field set to the Get Controller State (i.e., 0h);
b. the Sequence Indicator field set to the proper sequence value;
c. the Controller Identifier field set to the controller identifier for the Migratable Controller in the
Source NVM Subsystem;
d. the Controller State Version Index field set to an index into the NVMe Controller State Version
list in the Supported Controller State Formats data structure for MMC in the Source NVM
Subsystem (refer to Figure 345) if the NVMe defined controller state is required; and
e. the Controller State UUID Index field set to an index in the Vendor Specific Controller State
UUID Supported list in the Supported Controller State Formats Data Structure for MMC in the
Source NVM Subsystem (refer to Figure 345), if vendor specific controller state is required.
7. After the MMHS has transferred the obtained controller state information to the MMHD, the MMHD
sets that controller state into a Migratable Controller by submitting a sequence of one or more
Migration Send commands to the MMC in the Destination NVM Subsystem specifying:
•
the Select field set to Set Controller State (i.e., 2h);
•
the Sequence Indicator field set to the proper sequence value;
•
the Controller Identifier field set to the controller identifier for the Migratable Controller in
the Destination NVM Subsystem;
•
the Controller State Version Index field set to an index into the NVMe Controller State
Version list in the Supported Controller State Formats data structure for MMC in the
Destination NVM Subsystem (refer to Figure 345) if value of the NVMe Controller State
Size (NVMECSS) field is non-zero (refer to Figure 374); and
•
the Controller State UUID Index field set to an index in the Vendor Specific Controller State
UUID Supported list in the Supported Controller State Formats Data Structure for MMC in
the Source NVM Subsystem (refer to Figure 345), if the value of the Vendor Specific Size
(VSS) field is non-zero (refer to Figure 374).
8. The MMHD resumes operation on the Migratable Controller in the Destination NVM Subsystem
(i.e., the migrated controller) by submitting a Migration Send command to the MMC in the
Destination NVM Subsystem specifying:
•
the Select field set to Resume (i.e., 1h);
•
the Controller Identifier field (refer to Figure 368) set to the controller identifier for the
Migratable Controller to be resumed.
