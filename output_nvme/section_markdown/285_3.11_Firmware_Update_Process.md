### 3.11 Firmware Update Process

> **Section ID**: 3.11 | **Page**: 156-158

The process for a firmware update to be activated in a domain (refer to section 3.2.5) by a reset is:
1. The host issues a Firmware Image Download command to download the firmware image to a
controller. There may be multiple portions of the firmware image to download, thus the offset for
each portion of the firmware image being downloaded on that controller is specified in the Firmware
Image Download command. The data provided in the Firmware Image Download command should
conform to the Firmware Update Granularity indicated in the Identify Controller data structure or
the firmware update may fail;
2. After the firmware is downloaded to that controller, the next step is for the host to submit a Firmware
Commit command to that controller. The Firmware Commit command verifies that the last firmware
image downloaded is valid and commits that firmware image to the firmware slot indicated for future
use. A firmware image that does not start at offset zero, contains gaps, or contains overlapping
regions is considered invalid. A controller may employ additional vendor specific means (e.g.,
checksum, CRC, cryptographic hash, or a digital signature) to determine the validity of a firmware
image:
a. The Firmware Commit command may also be used to activate a firmware image associated
with a previously committed firmware slot;
3. The host performs an action that results in a Controller Level Reset (refer to section 3.7.2) on that
controller to cause the firmware image specified in the Firmware Slot field in the Firmware Commit
command to be activated:
a. In some cases, a Conventional Reset (refer to the NVMe over PCIe Transport Specification) or
NVM Subsystem Reset is required to activate a firmware image. This requirement is indicated
by Firmware Commit command specific status (refer to section 5.2.8.1);
and
4. After the reset has completed, the host re-initializes the controller. This includes re-allocating I/O
Submission and Completion Queues. Refer to sections 3.5.1 and 3.5.2.
The process for a firmware update to be activated on a domain without a reset is:
1. The host issues a Firmware Image Download command to download the firmware image to a
controller. There may be multiple portions of the firmware image to download, thus the offset for
each portion of the firmware image being downloaded on that controller is specified in the Firmware
Image Download command. The data provided in the Firmware Image Download command should
conform to the Firmware Update Granularity indicated in the Identify Controller data structure or
the firmware update may fail;
2. The host submits a Firmware Commit command on that controller with a Commit Action of 011b
which specifies that the firmware image should be activated immediately without reset. The
downloaded firmware image shall replace the firmware image in the firmware slot. If no firmware
image was downloaded since the last reset or Firmware Commit command, (i.e., the first step was
skipped), then that controller shall verify and activate the firmware image in the specified slot. If
that controller starts to activate the firmware image, any controllers affected by the new firmware
image send a Firmware Activation Starting asynchronous event to the host if Firmware Activation
Notices are enabled (refer to Figure 409):
a. The Firmware Commit command may also be used to activate a firmware image associated
with a previously committed firmware slot;
3. The controller completes the Firmware Commit command. The following actions are taken in
certain error scenarios:
a. If the firmware image is invalid, then the controller aborts the command with an appropriate
status code (e.g., Invalid Firmware Image);
b. If the firmware activation was not successful because a Controller Level Reset is required to
activate this firmware image, then the controller aborts the command with a status code of
Firmware Activation Requires Controller Level Reset and the firmware image is applied at the
next Controller Level Reset;
c. If the firmware activation was not successful because an NVM Subsystem Reset is required to
activate this firmware image, then the controller aborts the command with a status code of
Firmware Activation Requires NVM Subsystem Reset and the firmware image is applied at the
next NVM Subsystem Reset;
d. If the firmware activation was not successful because a Conventional Reset is required to
activate this firmware image, then the controller aborts the command with a status code of
Firmware Activation Requires Conventional Reset and the firmware image is applied at the
next Conventional Reset; and
e. If the firmware activation was not successful because the firmware activation time requires
more time than the time reported by the MTFA field in the Identify Controller data structure,
then the controller aborts the command with a status code of Firmware Activation Requires
Maximum Time Violation. In this case, the firmware image was committed to the specified
firmware slot. To activate that firmware image, the host may issue a Firmware Commit
command that specifies:
i. a Commit Action set to 010b (i.e., activate using a Controller Level Reset); and
ii. the same firmware slot.
If the controller transitions to the D3cold state (refer to the PCI Express Base Specification) after the
submission of a Firmware Commit command that attempts to activate a firmware image and before the
completion of that command, then the controller may resume operation with either the firmware image
active at the time the Firmware Commit command was submitted or the firmware image that was activated
by that command.
If the firmware image is not able to be successfully loaded, then the controller shall revert to the firmware
image present in the most recently activated firmware slot or the baseline read-only firmware image, if
available, and indicate the failure as an asynchronous event with a Firmware Image Load Error. If the
controller changes (e.g., reverts) the firmware image while a sanitize operation is in progress, then that
sanitize operation fails (refer to section 8.1.26.4).
If a host overwrites (i.e., updates) the firmware image in the active firmware slot, then the previously active
firmware image may no longer be available. As a result, any action (e.g., power cycling the controller) that
requires the use of that firmware slot may instead use the firmware image that is currently in that firmware
slot. If the firmware image that is currently in that firmware slot would be activated by such an action
replacing the currently active firmware, then:
•
this is a pending firmware activation with reset; and
•
a controller aborts subsequent:
o
Sanitize commands or Sanitize Namespace commands with a status code indicating the
appropriate reset required to activate the pending activation as defined in section 5.2.22;
and
o
Set Features commands requesting to change the settings of the specified personality as
defined in section 8.1.6.1.
A host should not overlap firmware/boot partition image update command sequences (refer to section
1.5.42). During a firmware image update command sequence, if a Firmware Image Download command or
a Firmware Commit command is submitted for another firmware/boot partition image update command
sequence, the results of both that command and the in-progress firmware image update are undefined.
A host should use the same controller or Management Endpoint (refer to the NVM Express Management
Interface Specification) for all commands that are part of a firmware image update command sequence. If
the commands for a single firmware/boot partition image update command sequence are submitted to more
than one controller and/or Management Endpoint, the controller may abort the Firmware Commit command
with Invalid Firmware Image status.
After downloading a firmware image, a host issues a Firmware Commit command before downloading
additional firmware images. Processing of the first Firmware Image Download command after completion
of a Firmware Commit command shall cause the controller to discard remaining portions, if any, of
downloaded images. If a reset occurs between a firmware download and completion of the Firmware
Commit command, then the controller shall discard all portion(s), if any, of downloaded images.
