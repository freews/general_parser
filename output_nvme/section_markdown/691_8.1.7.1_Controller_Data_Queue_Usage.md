##### 8.1.7.1 Controller Data Queue Usage

> **Section ID**: 8.1.7.1 | **Page**: 572-573

The controller uses the current Tail entry pointer to identify the next open CDQ slot. The controller
increments the Tail entry pointer after placing the new entry to the next open CDQ slot. If the Tail entry
pointer increment exceeds the CDQ size, then the Tail entry pointer shall roll to zero. The controller may
continue to place entries in free CDQ slots as long as the Full queue condition is not met (refer to section
3.3.1.5). The controller shall take CDQ wrap conditions into account.
The host uses the current Head entry pointer to identify the slot containing the next entry to be consumed.
The host increments the Head entry pointer after consuming the next entry from the CDQ. If the Head entry
pointer increment exceeds the CDQ size, the Head entry pointer shall roll to zero. The host may continue
to consume entries from the CDQ as long as the Empty queue condition is not met (refer to section 3.3.1.4).
Note: The host shall take CDQ wrap conditions into account.
A host issues a Set Features command specifying the Controller Data Queue feature to communicate a
new value of the Head entry pointer to the controller. If the host specifies an invalid value to the Head entry
pointer, then that Set Features command is aborted. This condition may be caused by a host attempting to
remove an entry from an empty CDQ.
A host checks a posted entries Controller Data Queue Phase Tag (CDQP) bits in memory to determine
whether new CDQ entries have been posted (refer to section 8.1.7.2). The CDQ Tail pointer is only used
internally by the controller and is not visible to the host.
An entry is posted to the CDQ when the controller write of that entry to the next free CDQ slot inverts the
Controller Data Queue Phase Tag (CDQP) bit from its previous value in memory (refer to section 8.1.7.2).
The controller generates a Controller Data Queue Tail Pointer event (refer to Figure 157) to the host to
indicate that the CDQ slot specified by the host in the Controller Data Queue feature (refer to section
5.2.26.1.23) has been posted if in the Controller Data Queue feature associated with the CDQ:
•
the Tail pointer value matches the value in the Tail Pointer Trigger (TPT) field; and
•
the Enable Tail Pointer Trigger (ETPT) bit is set to ‘1’.
A CDQ entry has been consumed by the host when the host submits a Set Features command specifying
the Controller Data Queue feature with a new value that indicates that the CDQ Head Pointer has moved
past the slot in which that CDQ entry was placed. A Set Features command specifying the Controller Data
Queue feature may indicate that one or more CDQ entries have been consumed.
Altering a CDQ entry after that entry has been posted but before that entry has been consumed results in
undefined behavior.
Refer to the specific type of CDQ to determine the behavior of a CDQ that has become full.
Refer to section 3.3.1.4 for the definition of an empty CDQ. Refer to section 3.3.1.5 for the definition of a
full CDQ.
If a CQD entry is constructed via multiple writes, the Controller Data Queue Phase Tag (CDQP) bit shall be
updated in the last write of that CDQ entry.
Refer to the applicable NVM Express I/O Command Set specifications for any specific requirements on the
use of CDQs.
