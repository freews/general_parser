{
  "section_index": 910,
  "section_id": "8.3.5.5.4",
  "title": "8.3.5.5.4 DH-HMAC-CHAP_Reply Message",
  "level": 5,
  "pages": {
    "start": 751,
    "end": 753,
    "count": 3
  },
  "content": {
    "text": "The DH-HMAC-CHAP_Reply message is sent from the host to the controller. The host may request\nauthentication of the controller to enable bidirectional authentication, by including a DH-HMAC-CHAP\nchallenge value C2 in this message. The challenge value C2 shall be different from the challenge value C1\nreceived in the DH-HMAC-CHAP Challenge message.\nThe format of the DH-HMAC-CHAP Reply message is shown in Figure 801.\nHash Length (HL): Shall be set to the length in bytes of the selected hash function, as specified in Figure\n798.\nChallenge Valid: If the host does not require bidirectional authentication or no establishment of a secure\nchannel after unidirectional authentication is sought (refer to section 8.3.5.5.9), this field shall be cleared to\n0h. Otherwise, this field shall be set to 01h.\nDH Value Length (DHVLEN): Diffie-Hellman exponential length. This length shall be a multiple of 4. If the\nDH group identifier is cleared to 0h (i.e., NULL DH exchange), this field shall be cleared to 0h. Otherwise,\nit shall be set to the length in bytes of the DH Value.\nSequence Number (SEQNUM): 32-bit sequence number S2. A random non-zero value shall be used as\nthe initial value. The sequence number is incremented modulo 232 after each use, except that the value 0h\nis skipped (i.e., incrementing the value FFFFFFFFh results in the value 00000001h). The value 0h is used\nto indicate that bidirectional authentication is not performed, but a challenge value C2 is carried in order to\ngenerate a pre-shared key (PSK) for subsequent establishment of a secure channel (refer to section\n8.3.5.5.9).\nResponse Value (RVAL): DH-HMAC-CHAP response value R1. The value of R1 is computed using the\nhash function H( ) selected by the HashID parameter in the DH-HMAC-CHAP_Challenge message, and\nthe augmented challenge Ca1. If the NULL DH group has been selected, the augmented challenge Ca1 is\nequal to the challenge C1 received from the controller (i.e., Ca1 = C1). If a non-NULL DH group has been\nselected, the augmented challenge is computed applying the HMAC function using the hash function H( )\nselected by the HashID parameter in the DH-HMAC-CHAP_Challenge message with the hash of the\nephemeral DH key resulting from the combination of the random value y selected by the host with the DH\nexponential (i.e., gx mod p) received from the controller as HMAC key (refer to RFC 2104) to the challenge\nC1 (i.e., Ca1 = HMAC(H((gx mod p)y mod p), C1) = HMAC(H(gxy mod p), C1)). The value of R1 shall be\ncomputed applying the HMAC function using the hash function H( ) selected by the HashID parameter in\nthe DH-HMAC-CHAP_Challenge message with key Kh as HMAC key to the concatenation of the\naugmented challenge Ca1, the sequence number S1, the transaction identifier T_ID, the secure channel\nconcatenation indication SC_C sent in the AUTH_Negotiate message, the eight ASCII characters\n”HostHost” to indicate the host is computing the reply, the host NQN not including the null terminator, a 00h\nbyte, and the NVM subsystem NQN not including the null terminator (i.e., R1 = HMAC(Kh, Ca1 || S1 || T_ID\n|| SC C || ”HostHost” || NQNh || 00h || NQNc)). Using C language notation:\nChallenge Value (CVAL): Shall be set to a random challenge value C2 (refer to section 8.3.5.5.7). Each\nchallenge value should be unique and unpredictable, since repetition of a challenge value in conjunction\nwith the same key may reveal information about the key or the correct response to this challenge. The\nalgorithm for generating the challenge value is outside the scope of this specification. Randomness of the\nchallenge value is crucial to the security of the protocol (refer to section 8.3.5.5.7). The CVAL length is the\nsame as the length of the selected hash function (i.e., HL).\nDH Value (DHV): Diffie-Hellman exponential. If the DH Value Length is cleared to 0h, this field is not\npresent. The DH Value shall be set to the value of gy mod p, where y is a random number selected by the\nhost that shall be at least 256 bits long (refer to section 8.3.5.5.7) and p and g shall have the values indicated\nin Figure 799, based on the selected DH group identifier.\nUpon receiving a DH-HMAC-CHAP_Reply message, if:\n•\nthe Hash Length (HL) does not match the value specified in Figure 798 for the selected hash\nfunction;\n•\nDHgID is non-zero and the DH Value Length (DHVLEN) is cleared to 0h; or\n•\nDHgID is non-zero and the DH Value (DHV) is 0, 1, or p-1;\nthen the controller shall:\n•\nreply with an AUTH_Failure1 message having reason code ‘Authentication failure’ and reason code\nexplanation ‘Incorrect payload’; and\n•\ndisconnect the NVMe over Fabrics connection.\nIn addition, the controller shall:\n•\ncheck the challenge value C2, if the Challenge Valid field is set to 01h, to verify it is different from\nthe challenge value C1 the controller previously sent. If C2 is equal to C1, the controller shall:\nreply with an AUTH_Failure1 message having reason code ‘Authentication failure’ and\nreason code explanation ‘Authentication failed’; and\ndisconnect the NVMe over Fabrics connection;\nand\n•\nverify the response value R1 using the negotiated hash function. If verification of the response value\nR1 does not succeed, the controller shall:\nreply with an AUTH_Failure1 message having reason code ‘Authentication failure’ and\nreason code explanation ‘Authentication failed’; and\ndisconnect the NVMe over Fabrics connection.\nIf verification of the response value R1 succeeds, the host has been authenticated and the controller shall\ncontinue with a DH-HMAC-CHAP_Success1 message.",
    "tables": [
      {
        "id": "table_751_722",
        "page": 751,
        "bbox": [
          125.0,
          722.0,
          872.0,
          901.0
        ],
        "image_path": "Table_8_3_5_5_4_DH_HMAC_CHAP_Reply_Message.png",
        "title": "Table_8_3_5_5_4_DH_HMAC_CHAP_Reply_Message",
        "merged_count": 2,
        "table_md": "| Bytes | Description |\n|:---|:---|\n| 0 | Authentication Type (AUTH_TYPE): 01h (i.e., DH-HMAC-CHAP) |\n| 1 | Authentication Identifier (AUTH_ID): 02h (i.e., DH-HMAC-CHAP Reply) |\n| 3:2 | Reserved |\n| 5:4 | Transaction Identifier (T_ID): 16-bit transaction identifier |\n| 6 | Hash Length (HL): Length in bytes of the selected hash function |\n| 7 | Reserved |\n| 8 | Challenge Valid (CVALID): <br> ![](https://i.imgur.com/1X0d0qB.png) |\n| | |\n| Bytes | Description |\n| 9 | Reserved |\n| 11:10 | DH Value Length (DHVLEN): Length in bytes of DH value. If no DH value is included in the message, then this field is cleared to 0h. |\n| 15:12 | Sequence Number (SEQNUM): Sequence number S₂ |\n| 15+HL:16 | Response Value (RVAL): Response R₁. |\n| 15+2*HL:16+HL | Challenge Value (CVAL): Challenge if valid (i.e., if the CVALID field is set to 01h), cleared to 0h otherwise. |\n| 15+2*HL+DHVLEN:6+2*HL | DH Value (DHV): DH exponential gʸ mod p. This field is not present (i.e., the CVAL field is the last field in the message) if DHVLEN is cleared to 0h. |"
      }
    ],
    "figures": []
  },
  "statistics": {
    "table_count": 1,
    "figure_count": 0
  }
}