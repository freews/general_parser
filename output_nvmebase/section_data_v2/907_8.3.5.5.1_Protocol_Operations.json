{
  "section_index": 907,
  "section_id": "8.3.5.5.1",
  "title": "8.3.5.5.1 Protocol Operations",
  "level": 5,
  "pages": {
    "start": 746,
    "end": 748,
    "count": 3
  },
  "content": {
    "text": "DH-HMAC-CHAP is a key based Authentication and key management protocol that uses the Challenge\nHandshake Authentication Protocol (CHAP, refer to RFC 1994) enhanced to use the Hashed Message\nAuthentication Code (HMAC) mechanism (refer to RFC 2104) with stronger hash functions and augmented\nwith an optional Diffie-Hellman (DH) exchange (refer to RFC 2631, clause 2.2.1). DH-HMAC-CHAP\nprovides bidirectional or unidirectional Authentication between a host and a controller.\nThe Diffie-Hellman part of the protocol is optional. When the Diffie-Hellman part of the protocol is not used,\nDH-HMAC-CHAP is referred to as HMAC-CHAP. If insufficiently random keys are used (refer to section\n8.3.5.5.7), HMAC-CHAP potentially allows a passive eavesdropper to discover the key through an off-line\ndictionary attack, so its usage should be minimized. DH-HMAC-CHAP provides strong protection from\npassive eavesdroppers. However, an active attacker could reduce the operation of this protocol so that only\nHMAC-CHAP is used, and as a result gain sufficient information to mount an off-line dictionary attack on\nthe HMAC-CHAP key.\nAn implementation that supports DH-HMAC-CHAP authentication shall support DH-HMAC-CHAP with a\nNULL DH exchange. All implementations of DH-HMAC-CHAP shall be configurable to require a DH\nexchange (i.e., to not use HMAC-CHAP).\nIn order to authenticate with the DH-HMAC-CHAP protocol, each host and NVM subsystem shall be\nprovided with a DH-HMAC-CHAP key that is associated with the entity’s NQN. Two entities may\nimpersonate one another if they have the same key, therefore when the assigned keys are not different for\neach entity there is a security vulnerability (refer to section 8.3.5.5.7).\nTo authenticate another entity, an entity is required to either:\na) know the key associated with the entity to be authenticated; or\nb) rely on a third party that knows the key to verify the authentication (refer to section 8.3.5.5.11).\nAn example of a DH-HMAC-CHAP authentication transaction is shown in Figure 795, with the notation\nshown in Figure 796. The DH-HMAC-CHAP_Success2 message that is shown as a dashed line is used\nonly for bidirectional authentication.\nWhen used with a non-NULL DH exchange, the DH-HMAC-CHAP protocol is able to generate a session\nkey KS to be used to establish a TLS session between host and controller (refer to section 8.3.5.5.9).\nFor an NVM subsystem, the controller is the entity running the protocol, using the identity and credentials\nof the NVM subsystem. The DH-HMAC-CHAP protocol proceeds in the following order:\n1) The authentication transaction shall begin with the host sending the common AUTH_Negotiate\nmessage to negotiate the authentication protocol to use and its associated parameters (refer to\nsection 8.3.5.4.1). The AUTH_Negotiate message carries the transaction identifier (T_ID) for the\nentire authentication transaction and the list of authentication protocol descriptors for the\nauthentication protocols that may be used in this authentication transaction. For DH-HMAC-CHAP,\nthe authentication protocol descriptor includes the list of hash functions (HashIDList) and Diffie-\nHellman group identifiers (DHgIDList) that may be used in this authentication protocol transaction.\n2) If the parameters of the received DH-HMAC-CHAP protocol descriptor are compatible with the\ncontroller’s policies, then the controller shall reply with a DH-HMAC-CHAP_Challenge message\n(refer to section 8.3.5.5.3) carrying the same transaction identifier value (T_ID) received in the\nAUTH_Negotiate message, the identifiers of the hash function (HashID) and the DH group (DHgID)\nselected for use among the ones proposed by the host in the AUTH_Negotiate message, a\nsequence number (S1), a random challenge value (C1), and the DH exponential (gx mod p). If the\ncontroller selects a NULL DH group identifier, then the DH portion of the DH-HMAC-CHAP protocol\nshall not be used, and the protocol reduces to a HMAC-CHAP transaction.\n3) If the received DH-HMAC-CHAP_Challenge message is valid, then the host shall send a DH-\nHMAC-CHAP_Reply message (refer to section 8.3.5.5.11) carrying the same transaction identifier\nvalue (T_ID), the response R1 to the challenge value C1, and its own DH exponential (gy mod p).\nThe DH Value Length shall be cleared to 0h if the controller has sent a NULL DH group identifier\nin the DH-HMAC-CHAP_Challenge message. If bidirectional authentication is requested, then the\nDH-HMAC-CHAP_Reply message shall carry also a sequence number S2 and a random challenge\nvalue C2 that differs from the challenge value C1 received in the DH-HMAC-CHAP_Challenge\nmessage.\n4) If the authentication verification by the controller succeeds, then the controller shall reply with a\nDH-HMAC-CHAP_Success1 message (refer to section 8.3.5.5.5) carrying the same transaction\nidentifier value (T_ID). If bidirectional authentication was requested, then the DH-HMAC-\nCHAP_Success1 message shall also carry the response R2 to the challenge value C2. If the\nauthentication verification fails, then the controller shall send an AUTH_Failure1 message and\ndisconnect the NVMe over Fabrics connection upon transmitting it.\n5) The authentication transaction ends here, unless bidirectional authentication has been requested.\nIn this case, as shown by the dashed arrow in Figure 795, if the authentication verification by the\nhost succeeds, then the host shall send a DH-HMAC-CHAP_Success2 message (refer to section\n8.3.5.5.6) carrying the same transaction identifier value (T_ID). If the authentication verification\nfails, then the host shall send an AUTH_Failure2 message and disconnect the NVMe over Fabrics\nconnection upon transmitting it.\nIf the controller receives a message that is not the expected next message in the DH-HMAC-CHAP protoco\nsequence, then the controller shall:\n•\nreply with an AUTH_Failure1 message having reason code ‘Authentication failure’ and reason code\nexplanation ‘Incorrect protocol message’; and\n•\ndisconnect the NVMe over Fabrics connection upon transmitting the AUTH_Failure1 message.\nIf the host receives a message that is not the expected next message in the DH-HMAC-CHAP protoco\nsequence, then the host shall:\n•\nreply with an AUTH_Failure2 message having reason code ‘Authentication failure’ and reason code\nexplanation ‘Incorrect protocol message’; and\n•\ndisconnect the NVMe over Fabrics connection upon transmitting the AUTH_Failure2 message.\nThe payload format of a message shall be validated before performing any other security computation.",
    "tables": [
      {
        "id": "table_747_586",
        "page": 747,
        "bbox": [
          114.0,
          586.0,
          883.0,
          811.0
        ],
        "image_path": "Table_8_3_5_5_1_Protocol_Operations.png",
        "title": "Table_8_3_5_5_1_Protocol_Operations",
        "table_md": "| Symbols | Description |\n| :--- | :--- |\n| NQN<sub>c</sub>, NQN<sub>h</sub> | NQN of the NVM subsystem that contains the controller and NQN of the host |\n| K<sub>c</sub>, K<sub>h</sub> | DH-HMAC-CHAP key of the NVM subsystem that contains the controller and DH-HMAC-CHAP key of the host |\n| p, g | Modulus (p) and generator (g) of the chosen DH group (refer to Figure 799) |\n| x, y | Random numbers used as exponents in a DH exchange |\n| C<sub>1</sub>, C<sub>2</sub> | Random challenge values |\n| C<sub>a1</sub>, C<sub>a2</sub> | Augmented challenge values |\n| S<sub>1</sub>, S<sub>2</sub> | 32-bit sequence numbers |\n| R<sub>1</sub>, R<sub>2</sub> | Reply values |\n| T, ID | Authentication transaction identifier |\n| SC, C | Secure channel concatenation indication |\n| H( ) | One-way hash function (refer to Figure 798) |\n| HMAC(K, Str) | HMAC function (refer to RFC 2104) with key K on string Str using hash function H( ) |\n| || Concatenation operation |\n| K<sub>S</sub> | Session key |"
      }
    ],
    "figures": [
      {
        "id": "figure_747_115",
        "page": 747,
        "bbox": [
          259.0,
          115.0,
          700.0,
          546.0
        ],
        "title": "Figure 796: Mathematical notations for DH-HMAC-CHAP",
        "image_path": "Figure_8_3_5_5_1_Protocol_Operations.png"
      }
    ]
  },
  "statistics": {
    "table_count": 1,
    "figure_count": 1
  }
}