{
  "section_index": 757,
  "section_id": "8.1.23",
  "title": "8.1.23 Replay Protected Memory Block",
  "level": 3,
  "pages": {
    "start": 633,
    "end": 637,
    "count": 5
  },
  "content": {
    "text": "The Replay Protected Memory Block (RPMB) provides a means for the system to store data to a specific\nmemory area in an authenticated and replay protected manner. This is provided by first programming\nauthentication key information to the controller that is used as a shared secret. The system is not\nauthenticated in this phase, therefore the authentication key programming should be done in a secure\nenvironment (e.g., as part of the manufacturing process). The authentication key is utilized to sign the read\nand write accesses made to the replay protected memory area with a Message Authentication Code (MAC).\nUse of random number (nonce) generation and a write count property provide additional protection against\nreplay of messages where messages could be recorded and played back later by an attacker.\nAny attempt to access the replay protected memory area prior to the Authentication Key being programmed\nresults in an RPMB Operation Result Operation Status field set to 07h (i.e., Authentication Key not yet\nprogrammed) (refer to Figure 692). Once the key is programmed, the RPMB Operation Result Operation\nStatus field shall not be set to 07h.\nAn Authenticated Data Write to the RPMB Device Configuration Block data structure that attempts to set\nthe Boot Partition Write Protection Enabled bit when RPMB Boot Partition Write Protection is not supported\nresults in an RPMB Operation Result Operation Status of 05h (i.e., Write failure in the RPMB Operation\nStatus field) (refer to Figure 692).\nAn Authenticated Data Write to the RPMB Device Configuration Block data structure that attempts to set\nthe Boot Partition Write Protection Enabled bit when either Boot Partition is in the Write Locked Until Power\nCycle state (refer to section 5.2.26.1.36 and section 8.1.3.3.1) results in an RPMB Operation Result\nOperation Status of 05h (i.e., Write failure in the RPMB Operation Status field) (refer to Figure 692).\nAn Authenticated Data Write to the RPMB Device Configuration Block data structure that attempts to\nchange either the Boot Partition 0 Write Locked bit or the Boot Partition 1 Write Locked bit when the Boot\nPartition Write Protection Enabled bit is cleared to ‘0’ results in an RPMB Operation Result Operation Status\nfield set to 05h (i.e., Write failure) (refer to Figure 692).\nIf Set Features Boot Partition Write Protection is supported, then an Authenticated Data Write to the RPMB\nDevice Configuration Block data structure that successfully enables RPMB Boot Partition Write Protection\nshall also result in the controller changing the Boot Partition 0 Write Protection State and Boot Partition 1\nWrite Protection State values in the Boot Partition Write Protection Config feature to a value of 100b to\nindicate that Boot Partition write protection is controlled by RPMB.\nThe controller may support multiple RPMB targets. RPMB targets are not contained within a namespace.\nControllers in the NVM subsystem may share the same RPMB targets. Security Send and Security Receive\ncommands for RPMB do not use the namespace ID field; NSID shall be cleared to 0h. Each RPMB target\noperates independently – there may be requests outstanding to multiple RPMB targets at once (where the\nrequests may be interleaved between RPMB targets). In order to guarantee ordering the host should issue\nand wait for completion for one Security Send or Security Receive command at a time. Each RPMB target\nrequires individual authentication and key programming. Each RPMB target may have its own unique\nAuthentication Key.\nThe message types defined in Figure 691 are used by the host to communicate with an RPMB target.\nRequest Message Types are sent from the host to the controller using Security Send commands. Response\nMessage Types are retrieved by the host from the controller using Security Receive commands.\nFigure 690 defines the RPMB Device Configuration Block data structure – the non-volatile contents stored\nwithin the controller for RPMB target 0.\nThe operation result defined in Figure 692 indicates whether an RPMB request was successful or not.\nEach RPMB Data Frame is 256 bytes in size plus the size of the Data field, and is organized as shown in\nFigure 694. RPMB uses a sector size of 512 bytes. The RPMB sector size is independent and not related\nto the user data size used for the namespace(s).\nSecurity Send and Security Receive commands are used to encapsulate and deliver data packets of any\nsecurity protocol between the host and controller without interpreting, dis-assembling or re-assembling the\ndata packets for delivery. Security Send and Security Receive commands used for RPMB access are\npopulated with the RPMB Data Frame(s) defined in Figure 694. The controller shall not return successful\ncompletion of a Security Send or Security Receive command for RPMB access until the requested RPMB\nRequest/Response Message Type indicated is completed. The Security Protocol used for RPMB is defined\nin section 5.2.24.3.",
    "tables": [
      {
        "id": "table_634_644",
        "page": 634,
        "bbox": [
          115.0,
          644.0,
          907.0,
          783.0
        ],
        "image_path": "Table_8_1_23_Replay_Protected_Memory_Block.png",
        "title": "Table_8_1_23_Replay_Protected_Memory_Block",
        "merged_count": 7,
        "table_md": "| Bytes | Type | Description |\n| :--- | :--- | :--- |\n| 00 | RW | **Boot Partition Protection Enable (BPPEE):** This field specifies whether Boot Partition Protection is enabled. <br> <table> <tr> <th>Bits</th> <th>Description</th> </tr> <tr> <td>7:1</td> <td>Reserved</td> </tr> <tr> <td>0</td> <td><b>Boot Partition Write Protection Enabled (BPPED):</b>If this bit is set to '1', then RPMB Boot Partition Write Protection is enabled. If this bit is cleared to '0', then RPMB Boot Partition Write Protection is disabled or not supported. Once enabled, the controller shall prevent disabling RPMB Boot Partition Write Protection.</td> </tr> </table> |\n| | | |\n| Bytes | Type | Description |\n| :--- | :--- | :--- |\n| 01 | RW | **Boot Partition Protection State (BPLS):** This field specifies the current Boot Partition protection state when RPMB Boot Partition Write Protection is enabled. This field shall be cleared to 0h unless RPMB Boot Partition Write Protection is enabled. Refer to section 8.1.3.3. <br> <table> <tr> <th>Bits</th> <th>Description</th> </tr> <tr> <td>7:2</td> <td>Reserved</td> </tr> <tr> <td>1</td> <td><b>Boot Partition 1 Write Locked (BPP1L):</b>If this bit is set to '1', then Boot Partition 1 (i.e., the BPID bit in Figure 185 is set to '1') is write locked. If this bit is cleared to '0', then the Boot Partition 1 is write unlocked.</td> </tr> <tr> <td>0</td> <td><b>Boot Partition 0 Write Locked (BPP0L):</b>If this bit is set to '1', then Boot Partition 0 (i.e., the BPID bit in Figure 185 is set to '0') is write locked. If this bit is cleared to '0', then the Boot Partition 0 is write unlocked.</td> </tr> </table> |\n| 02 | RW | **Write Protection Control (WPC):** This field specifies whether the controller processes or aborts Set Features commands which enable certain write protection states (refer to section 8.1.17 and section 5.2.26.1.35). If the controller does not support Namespace Write Protection, then this field shall be cleared to 0h. <br> <table> <tr> <th>Bits</th> <th>Description</th> </tr> <tr> <td>7:2</td> <td>Reserved</td> </tr> <tr> <td>1</td> <td><b>Permanent Write Protect Control (PWPC):</b>This bit cleared to '0' specifies that the controller aborts a Set Features command which attempts to set the namespace write protection state to Permanent Write Protect, as defined in section 8.1.17. This bit set to '1' specifies that the controller processes a Set Features command which attempts to set the namespace write protection state to Permanent Write Protect. <br> If the controller supports Namespace Write Protection, then this bit shall be cleared to '0' after a power cycle or a Controller Level Reset.</td> </tr> <tr> <td>0</td> <td><b>Write Protect Until Power Cycle Control (WPUPPC):</b>This bit cleared to '0' specifies that the controller aborts a Set Features command which attempts to set the namespace write protection state to Write Protect Until Power Cycle, as defined in section 8.1.17. This bit set to '1' specifies that the controller processes a Set Features command which sets the namespace write protection state to Write Protect Until Power Cycle. <br> If the controller supports Namespace Write Protection, then this bit shall be cleared to '0' after a power cycle or a Controller Level Reset.</td> </tr> </table> |\n| 511:03 | | Reserved |\n| | | |\n| Request Message Types | Description | Requires Data | RPMB Frame Length (bytes) |\n| :--- | :--- | :--- | :--- |\n| 0001h | Authentication key programming request | No | 256 |\n| 0002h | Reading of the Write Counter value request | No | 256 |\n| 0003h | Authenticated data write request | Yes | M + 256 |\n| 0004h | Authenticated data read request | No | 256 |\n| 0005h | Result read request | No | 256 |\n| | | | |\n| Request Message Types | Description | Requires Data | RPMB Frame Length (bytes) |\n| :--- | :--- | :--- | :--- |\n| 0006h | Authenticated Device Configuration Block write request | Yes | 512 + 256 |\n| 0007h | Authenticated Device Configuration Block read request | No | 256 |\n| 0100h | Returned as a result of the host requesting a Result read request Message Type after programming the Authentication Key. | No | 256 |\n| 0200h | Reading of the Write Counter value response | No | 256 |\n| 0300h | Authenticated data write response | No | 256 |\n| 0400h | Authenticated data read response | Yes | M + 256 |\n| 0600h | Authenticated Device Configuration data write response | No | 256 |\n| 0700h | Authenticated Device Configuration data read response | Yes | 512 + 256 |\n| | | | |\n| Bits | Description |\n| :--- | :--- |\n| 15:08 | Reserved |\n| 07 | **Write Counter Status (WCS):** Indicates if the Write Counter has expired (i.e., reached its maximum value). A value of '1' indicates that the Write Counter has expired. A value of '0' indicates a valid Write Counter. |\n| 06:00 | **Operation Status (OPSTAT):** Indicates the operation status. Valid operation status values are listed below. <br> <table> <tr> <th>Value</th> <th>Definition</th> </tr> <tr> <td>00h</td> <td>Operation successful</td> </tr> <tr> <td>01h</td> <td>General failure</td> </tr> <tr> <td>02h</td> <td>Authentication failure (MAC comparison not matching, MAC calculation failure)</td> </tr> <tr> <td>03h</td> <td>Counter failure (counters not matching in comparison, counter incrementing failure)</td> </tr> <tr> <td>04h</td> <td>Address failure (address out of range, wrong address alignment)</td> </tr> <tr> <td>05h</td> <td>Write failure (data/counter/result write failure)</td> </tr> <tr> <td>06h</td> <td>Read failure (data/counter/result read failure)</td> </tr> <tr> <td>07h</td> <td>Authentication Key not yet programmed</td> </tr> <tr> <td>08h</td> <td>Invalid RPMB Device Configuration Block – this may be used when the target is not 0h.</td> </tr> <tr> <td>09 to 3Fh</td> <td>Reserved</td> </tr> </table> |\n| | | |\n| Content | Type | Size | Description |\n| :--- | :--- | :--- | :--- |\n| Authentication Key | Write once, not erasable or readable | | Authentication key which is used to authenticate accesses when MAC is calculated. |\n| Write Counter | Read only | 4 bytes | Counter value for the total amount of successful authenticated data write requests made by the host. The initial value of this property after manufacture is 00000000h. This value is incremented by one automatically by the controller with each successful programming access. After the counter has reached the maximum value of FFFFFFFFh, the controller shall no longer increment to prevent overflow. |\n| RPMB Data Area | Readable and writable, not erasable | Size is reported in Identify Controller data structure (128 KiB minimum, 32 MiB maximum) | Data that is able to be read and written only via successfully authenticated read/write access. |\n| | | | |\n| Bytes | | | |\n| :--- | :--- | :--- | :--- |\n| 222:N00 | Stuff Bytes (STBY): Padding for the frame. Values in this field are not part of the MAC calculation. The size is 223 bytes minus the size of the Authentication Key (N). | | |\n| 222:222-(N-1) | Message Authentication Code / Authentication Key (MAC/Key): Size is dependent on authentication method reported in the Identify Controller data structure (e.g., SHA-256 key is 32 bytes (refer to RFC 6234)). | | |\n| 223 | **RPMB Target (RBT):** Indicates which RPMB Request/Response is targeted for. Values 0-6 are supported. If the value in this field is not equal to the NVMe Security Specific Field (NSSF) in the Security Send or Security Receive command, then the controller shall return an error of Invalid Field in Command for the Security Send or Security Receive command. | | |\n| 239:224 | **Nonce (NCE):** Random number generated by the host for the requests and copied to the response by the RPMB target. | | |\n| 243:240 | **Write Counter (WCNTR):** Total amount of successfully authenticated data write requests. | | |\n| 247:244 | **Address (ADDR):** Starting address of data to be programmed to or read from the RPMB. | | |\n| 251:248 | **Sector Count (SCNT):** Number of sectors (512 bytes) requested to be read or written. | | |\n| 253:252 | **Result (RSLT):** Defined in Figure 692. Note: The Result field is not needed for Requests. | | |\n| 255:254 | **Request or Response Message (RRM):** Defined in Figure 691. | | |\n| (M-1)+256:256 | **Data (DATA):** Data to be written or read by signed access where M = 512 * Sector Count. This field is optional. | | |"
      }
    ],
    "figures": []
  },
  "statistics": {
    "table_count": 1,
    "figure_count": 0
  }
}