{
  "section_index": 725,
  "section_id": "8.1.13.1",
  "title": "8.1.13.1 Process for Migrating a Controller",
  "level": 4,
  "pages": {
    "start": 601,
    "end": 603,
    "count": 3
  },
  "content": {
    "text": "This section provides an example sequence of steps to allow the MMHS to migrate a Migratable Controller\nin the Source NVM Subsystem and the attached namespaces to a Migratable Controller in the Destination\nNVM Subsystem (refer to Figure 667). Additionally, the steps include obtaining the host memory\nmodifications made to the host due to the Migratable Controller in the Source NVM Subsystem processing\ncommands during the migration.\nIn this example the MMC in the Source NVM Subsystem has:\n•\nthe Track User Data Changes Support (TUDCS) bit set to ‘1’ in the Tracking Attributes (TRATTR)\nfield in the Identify Controller data structure (refer to Figure 328); and\n•\nthe Track Host Memory Changes Support (THMCS) bit set to ‘1’ in the Tracking Attributes\n(TRATTR) field in the Identify Controller data structure.\nIf attached namespaces are not required to be migrated by the MMHS, then those steps may be ignored.\nIf host memory modifications are not required to be obtained by the MMHS, then those steps may be\nignored.\n1. The MMHS copies (i.e., migrates) the user data in namespaces attached to the Migratable\nController in the Source NVM Subsystem while the host is submitting commands and the\nMigratable Controller is processing those submitted commands.\na. The MMHS creates a User Data Migration Queue in the MMC in the Source NVM Subsystem\nby submitting a Controller Data Queue command to that MMC (refer to section 5.2.4)\nspecifying:\n•\nthe Select field set to the Create Controller Data Queue (i.e., 0h);\n•\nthe Queue Type field set to User Data Migration Queue; and\n•\nthe Controller Identifier field (refer to Figure 170) set to the controller identifier for the\nMigratable Controller in the Source NVM Subsystem.\nb. If the Controller Data Queue command is successful, the completion queue entry contains the\nController Data Queue Identifier for the created User Data Migration Queue. The MMHS\ncauses the MMC in the Source NVM Subsystem to post user data modifications to namespaces\nattached to the Migratable Controller by submitting a Track Send command (refer to section\n5.2.28) to that MMC specifying:\n•\nthe Select field set to Log User Data Changes (i.e., 0h);\n•\nthe Logging Action bit set to ‘1’ (i.e., start logging); and\n•\nthe Controller Data Queue Identifier field set to the Controller Data Queue Identifier from\nthe completion queue entry for the Controller Data Queue command.\nIt is the responsibility of the MMHS to make sure that the User Data Migration Queue is sized\nproperly and there may be more restrictions on that MMHS as specified by the appropriate I/O\ncommand set (e.g., the NVM Command Set requires the MMHS to not allow the User Data\nMigration Queue to become full). Refer to section 8.1.7 for a description of the User Data\nMigration Queue (i.e., a Controller Data Queue).\n(\n,\n)\nc. If the Track Send command is successful, then the MMHS starts copying the namespaces\nattached to the Migratable Controller in the Source NVM Subsystem to the Destination NVM\nSubsystem. Refer to the applicable NVM Express I/O Command Set specifications for\ncapabilities that may reduce the amount of user data that is required to copied (e.g., the Get\nLBA Status command in the NVM Express NVM Command Set Specification).\n2. The MMHS causes the MMC in the Source NVM Subsystem to start tracking the modifications to\nhost memory in the host due to the Migratable Controller processing submitted commands.\na. The MMHS submits a Track Send command to the MMC in the Source NVM Subsystem (refer\nto section 5.2.28) specifying:\n•\nthe Select field set to the Track Memory Changes (i.e., 1h);\n•\nthe Tracking Action (TACT) bit set to ‘1’;\n•\nthe Controller Identifier field specifying the identifier for the Migratable Controller in the\nSource NVM Subsystem being migrated; and\n•\na Track Memory Changes data structure in the data buffer specifying the host memory to\nbe tracked as described by the set of host memory ranges.\nb. If the Track Send command is successful, then the MMHS may query the host memory\nmodifications that have resulted from the Migratable Controller processing commands by\nsubmitting a Track Receive command (refer to section 5.2.27) to the MMC in the Source NVM\nSubsystem specifying:\n•\nthe Select field set to the Track Memory Changes (i.e., 0h); and\n•\nthe Controller Identifier field specifying the identifier for the Migratable Controller in the\nSource NVM Subsystem being migrated.\n3. Once the MMHS has copied the namespaces attached to the Migratable Controller in the Source\nNVM Subsystem, that MMHS determines a time to suspend that Migratable Controller. During this\nperiod, that MMHS is migrating the user data in the namespaces attached to that Migratable\nController that are identified in the posted entries in the User Data Migration Queue. That MMHS\nmay handle the modified host memory in the host as reported by the Track Receive command.\n4. The MMHS suspends the Migratable Controller in the Source NVM Subsystem by submitting a\nMigration Send command to the MMC in the Source NVM Subsystem specifying:\n•\nthe Select field set to the Suspend (i.e., 0h);\n•\nthe Suspend Type field set to Suspend (i.e., 1h);\n•\nDelete User Data Migration Queue bit set to ‘1’, if the MMHS desires that the MMC delete\nthe User Data Migration Queue being used to log user data changes of the Migratable\nController being migrated; and\n•\nthe Controller Identifier field (refer to Figure 367) set to the controller identifier for the\nMigratable Controller to be suspended (i.e., the Migratable Controller being migrated).\nPrior to completing that Migration Send command:\n•\nthe specified Migratable Controller being suspended:\nstops fetching commands (i.e.; from the Admin queue and I/O queues); and\ncompletes all previously fetched commands;\nand\n•\nthe MMC processing that Migration Send command:\nif user data is being logged into a User Data Migration Queue that is associated with\nthe Migratable Controller being migrated, an entry is placed into the User Data\nMigration Queue that indicates the user data logging has suspended, and then deletes\nthe User Data Migration Queue, if the Delete User Data Migration Queue bit is set to\n‘1’\n5. Since the Migratable Controller in the Source NVM Subsystem is suspended, the MMHS migrates\nthe user data in the namespaces attached to the Migratable Controller that are identified in the\nposted entries in the User Data Migration Queue. Refer to the applicable NVM Express I/O\nCommand Set specification to determine how the entries identify when entries have completed\nbeing posted. That MMHS may handle the modified host memory in the host as reported by the\nTrack Receive command.\n6. The MMHS is able to obtain the controller state of the Migratable Controller in the Source NVM\nSubsystem by submitting one or more Migration Receive commands to the MMC in the Source\nNVM Subsystem specifying:\na. the Select field set to the Get Controller State (i.e., 0h);\nb. the Sequence Indicator field set to the proper sequence value;\nc. the Controller Identifier field set to the controller identifier for the Migratable Controller in the\nSource NVM Subsystem;\nd. the Controller State Version Index field set to an index into the NVMe Controller State Version\nlist in the Supported Controller State Formats data structure for MMC in the Source NVM\nSubsystem (refer to Figure 345) if the NVMe defined controller state is required; and\ne. the Controller State UUID Index field set to an index in the Vendor Specific Controller State\nUUID Supported list in the Supported Controller State Formats Data Structure for MMC in the\nSource NVM Subsystem (refer to Figure 345), if vendor specific controller state is required.\n7. After the MMHS has transferred the obtained controller state information to the MMHD, the MMHD\nsets that controller state into a Migratable Controller by submitting a sequence of one or more\nMigration Send commands to the MMC in the Destination NVM Subsystem specifying:\n•\nthe Select field set to Set Controller State (i.e., 2h);\n•\nthe Sequence Indicator field set to the proper sequence value;\n•\nthe Controller Identifier field set to the controller identifier for the Migratable Controller in\nthe Destination NVM Subsystem;\n•\nthe Controller State Version Index field set to an index into the NVMe Controller State\nVersion list in the Supported Controller State Formats data structure for MMC in the\nDestination NVM Subsystem (refer to Figure 345) if value of the NVMe Controller State\nSize (NVMECSS) field is non-zero (refer to Figure 374); and\n•\nthe Controller State UUID Index field set to an index in the Vendor Specific Controller State\nUUID Supported list in the Supported Controller State Formats Data Structure for MMC in\nthe Source NVM Subsystem (refer to Figure 345), if the value of the Vendor Specific Size\n(VSS) field is non-zero (refer to Figure 374).\n8. The MMHD resumes operation on the Migratable Controller in the Destination NVM Subsystem\n(i.e., the migrated controller) by submitting a Migration Send command to the MMC in the\nDestination NVM Subsystem specifying:\n•\nthe Select field set to Resume (i.e., 1h);\n•\nthe Controller Identifier field (refer to Figure 368) set to the controller identifier for the\nMigratable Controller to be resumed.",
    "tables": [],
    "figures": []
  },
  "statistics": {
    "table_count": 0,
    "figure_count": 0
  }
}