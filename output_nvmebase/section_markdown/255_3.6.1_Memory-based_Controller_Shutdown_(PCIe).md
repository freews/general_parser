#### 3.6.1 Memory-based Controller Shutdown (PCIe)

> **Section ID**: 3.6.1 | **Page**: 137-138

It is recommended that the host perform an orderly shutdown of the controller by following the procedure
in this section when a power-off or shutdown condition is imminent.
The host should perform the following actions in sequence for a normal controller shutdown:
1. If the controller is enabled (i.e., CC.EN (refer to Figure 41) is set to ‘1’):
a. Stop submitting any new I/O commands to the controller and allow any outstanding
commands to complete;
b. If the controller implements I/O queues, then the host should delete all I/O Submission
Queues, using the Delete I/O Submission Queue command (refer to section 5.3.4). A result
of the successful completion of the Delete I/O Submission Queue command is that any
remaining commands outstanding are aborted;
c. If the controller implements I/O queues, then the host should delete all I/O Completion
Queues, using the Delete I/O Completion Queue command (refer to section 5.3.3);
and
2. The host should set the Shutdown Notification (CC.SHN) field (refer to Figure 41) to 01b to indicate
a normal controller shutdown operation. The controller indicates when shutdown processing is
completed by updating the Shutdown Status (CSTS.SHST) field to 10b and the Shutdown Type
(CSTS.ST) field (refer to Figure 42) is cleared to ‘0’.
The host should perform the following actions in sequence for an abrupt shutdown:
1. If the controller is enabled (i.e., CC.EN is set to ‘1’), then stop submitting any new I/O commands
to the controller; and
2. The host should set the Shutdown Notification (CC.SHN) field (refer to Figure 41) to 10b to indicate
an abrupt shutdown operation. The controller indicates when shutdown processing is completed
by updating the Shutdown Status (CSTS.SHST) field (refer to Figure 42) to 10b and CSTS.ST
(refer to Figure 42) is cleared to ‘0’.
For entry to the D3 power state (refer to the PCI Express Base Specification), the shutdown steps outlined
for a normal controller shutdown should be followed.
It is recommended that the host wait a minimum of the RTD3 Entry Latency reported in the Identify
Controller data structure (refer to Figure 328) for the shutdown operations to complete; if the value reported
in RTD3 Entry Latency is 0h, then the host should wait for a minimum of one second. While shutdown
processing is in progress on a controller, it is not recommended to disable that controller via the CC.EN bit
(i.e., via a Controller Reset), which may impact the time required to complete shutdown processing. While
shutdown processing is in progress on a controller, that controller may abort any command with a status
code of Commands Aborted due to Power Loss Notification.
The controller is ready to be powered off (e.g., the media is in the shutdown state (refer to Figure 85)) when
the CSTS.ST bit is cleared to ‘0’, and the CSTS.SHST field indicates that controller shutdown processing
is complete (i.e., the CSTS.SHST field is set to 10b), regardless of the value of the CC.EN bit. The controller
remains ready to be powered off (e.g., the media remains in the shutdown state) until:
A. the controller is enabled (i.e., the CC.EN bit transitions from ‘0’ to ‘1’);
B. the controller is reset by a Controller Level Reset; or
C. an Admin command that requires access to the media (refer to Figure 84) and specifies the Ignore
Shutdown bit set to ‘1’ is processed by the controller via the out-of-band mechanism (refer to the
NVM Express Management Interface Specification).
If a Controller Level Reset occurs while controller shutdown processing is reported as complete (i.e., the
CSTS.ST bit is cleared to ‘0’ and the CSTS.SHST field is set to 10b), then the controller may remain ready
to be powered off (e.g., the media remains in the shutdown state) or the controller may cease being ready
to be powered off (e.g., because the controller is preparing the media for use (refer to section 3.7.2)).
If the power scope for the controller includes multiple controllers (e.g., the CAP.CPS field is set to 10b or is
set to 11b), and any controller included in that power scope is not ready to be powered off, then the portion
of the NVM subsystem included in that power scope is not ready to be powered off.
To start executing commands on the controller after that controller reports controller shutdown processing
complete (i.e., the CSTS.ST bit is cleared to ‘0’ and the CSTS.SHST field is set to 10b) utilizing the CC.EN
bit:
•
if the CC.EN bit is set to ‘1’, then a Controller Level Reset is required to clear the CC.EN bit to ‘0’
on that controller and the CC.EN bit is subsequently required to be set to ‘1’ as part of the
initialization sequence (refer to section 3.5); and
•
if the CC.EN bit is cleared to ‘0’, then:
a Controller Level Reset is required and the CC.EN bit is subsequently required to be set
to ‘1’ as part of the initialization sequence (refer to section 3.5); or
the CC.EN bit is required to be set to ‘1’ and the CC.SHN field is required to be cleared to
00b with the same write to the CC property (refer to Figure 41). The controller clears the
CSTS.SHST field to 00b in response to that write.
The initialization sequence (refer to section 3.5) should then be executed on that controller.
It is an implementation choice whether the host aborts all outstanding commands to the Admin Queue prior
to the controller shutdown. The only commands that should be outstanding to the Admin Queue when the
controller reports shutdown processing complete are Asynchronous Event Request commands.
If the host is no longer able to communicate with the controller before that host receives either:
•
completions for all outstanding commands submitted to that controller (refer to section 3.4.5); or
•
a CSTS.SHST field value that indicates that the controller shutdown is complete,
then it is strongly recommended that the host take the steps described in section 9.6 to avoid possible data
corruption caused by interaction between outstanding commands and subsequent commands submitted
by that host to another controller.
