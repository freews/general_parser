#### 8.2.6 Virtualization Enhancements

> **Section ID**: 8.2.6 | **Page**: 693-695

Virtualized environments may use an NVM subsystem with multiple controllers to provide virtual or physical
hosts direct I/O access. The NVM subsystem is composed of primary controller(s) and secondary
controller(s), where the secondary controller(s) depend on primary controller(s) for dynamically assigned
resources. A host may issue the Identify command to a primary controller specifying the Secondary
Controller List to discover the secondary controllers associated with that primary controller. All secondary
controllers shall be part of the same domain as the primary controller with which they are associated.
Controller resources may be assigned or removed from a controller using the Virtualization Management
command (refer to section 5.3.6) issued to a primary controller. The following types of controller resources
are defined:
•
Virtual Queue Resource (VQ Resource): a type of controller resource that manages one
Submission Queue (SQ) and one Completion Queue (CQ) (refer to section 8.2.6.1); and
•
Virtual Interrupt Resource (VI Resource): a type of controller resource that manages one interrupt
vector (refer to section 8.2.6.2).
Flexible Resources are controller resources that may be assigned to the primary controller or one of its
secondary controllers. The Virtualization Management command is used to provision the Flexible
Resources between a primary controller and one of its secondary controller(s). A primary controller’s
allocation of Flexible Resources may be modified using the Virtualization Management command and the
change takes effect as a result of the next Controller Level Reset initiated by any method other than a
Controller Reset. A secondary controller only supports having Flexible Resources assigned or removed
when in the Offline state.
Private Resources are controller resources that are permanently assigned to a primary or secondary
controller. These resources are not supported by the Virtualization Management command.
The primary controller is allowed to have a mix of Private and Flexible Resources for a particular controller
resource type. If there is a mix, then the Private Resources occupy the lower contiguous range of resource
identifiers starting with 0. Secondary controllers shall have all Private or all Flexible Resources for a
particular resource type. Controller resources assigned to a secondary controller always occupy a
contiguous range of identifiers with no gaps, starting with 0. If a particular controller resource type is
supported as indicated in the Controller Resource Types field of the Primary Controller Capabilities
Structure, then all secondary controllers shall have that controller resource type assigned as a Flexible
Resource. Figure 728 shows the controller resource allocation model for a controller resource type that is
assignable as a Flexible Resource.
For each controller resource type supported, the Primary Controller Capabilities Structure (refer to Figure
346) defines:
•
The total number of Flexible Resources;
•
The total number of Private Resources for the primary controller;
•
The maximum number of Flexible Resources that may be assigned to a secondary controller using
the Virtualization Management command; and
•
The assignment of resources to the primary controller.
Primary and secondary controllers may implement all features of this specification, except where
commands are defined as being only supported by a primary controller. It is recommended that only primary
controllers support the privileged actions described in section 3.10 so that untrusted hosts using secondary
controllers do not impact the entire NVM subsystem state.
The Secondary Controller List structure returned by the Identify command is used to determine the topology
of secondary controllers and the resources assigned. The secondary controller shall be in the Offline state
to configure resources. The Virtualization Management command is used to transition the secondary
controller between the Online state and the Offline state. Refer to section 8.2.6.3 for details on the Online
and Offline states.
To support the Virtualization Enhancements capability, the NVM subsystem shall support the following:
•
One or more primary controllers, each of which supports:
o
One or more secondary controllers;
o
A pool of unassigned Flexible Resources that supports allocation to a primary controller and
dynamic assignment to its associated secondary controllers;
o
Two or more Private Resource queue pairs;
o
Indicate support for the Virtualization Management command by setting the VMS bit to ‘1’ in
the Optional Admin Command Support (OACS) field in the Identify Controller data structure;
o
The Virtualization Management command;
o
The Primary Controller Capabilities Structure defined in Figure 346 (Identify command with
CNS value of 14h);
o
The Secondary Controller List defined in Figure 346 (Identify command with CNS value of 15h);
and
o
The Namespace Management capability (refer to section 8.1.16);
•
One or more secondary controllers; and
•
Flexible Resources, each of which supports all of the following:
o
Assignment and removal by exactly one primary controller; and
o
Assignment to no more than one controller at a time.
Within an NVM subsystem that supports both the Virtualization Enhancements capability and SR-IOV (refer
to section 8.2.6.4), all controllers that are SR-IOV PFs shall be primary controllers, and all controllers that
are SR-IOV VFs shall be secondary controllers of their associated PFs.
