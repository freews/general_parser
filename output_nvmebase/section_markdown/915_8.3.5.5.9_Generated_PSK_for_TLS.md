###### 8.3.5.5.9 Generated PSK for TLS

> **Section ID**: 8.3.5.5.9 | **Page**: 756-756

When used with a non-NULL DH exchange, the DH-HMAC-CHAP protocol is able to generate a session
key KS used to generate a pre-shared key (PSK) to establish a secure channel session with the TLS protocol
between host and controller for NVMe/TCP. A TLS session is concatenated to an authentication transaction
when the SC_C indication is set to NEWTLSPSK in the AUTH_Negotiate message (refer to section 8.3.5.1).
A TLS session shall not be concatenated to an authentication transaction if the involved host and controller
are administratively configured with a PSK for use with each other. In this case, host and controller shall
only establish a TLS session based on the retained PSK derived from that configured PSK.
The session key KS shall be computed from the ephemeral DH key (i.e., gxy mod p) generated during the
DH-HMAC-CHAP transaction by applying the hash function H( ) selected by the HashID parameter in the
DH-HMAC-CHAP_Challenge message (i.e., KS = H(gxy mod p)). The size of the session key KS is
determined by the selected hash function, as shown in Figure 798. Specifically:
•
The host computes KS as the hash of the ephemeral DH key resulting from the combination of the
random value y selected by the host with the DH exponential (i.e., gx mod p) received from the
controller (i.e., KS = H((gx mod p)y mod p) = H(gxy mod p)).
•
The controller computes KS as the hash of the ephemeral DH key resulting from the combination
of the random value x selected by the controller with the DH exponential (i.e., gy mod p) received
from the host (i.e., KS = H((gy mod p)x mod p) = H(gxy mod p)).
The generated PSK for TLS shall be computed applying the HMAC function using the hash function H( )
selected by the HashID parameter in the DH-HMAC-CHAP_Challenge message with the session key KS
as key to the concatenation of the two challenges C1 and C2 (i.e., generated PSK = HMAC(KS, C1 || C2)).
This generated PSK should be replaced periodically (e.g., every hour) or on demand by performing a
reauthentication on the Admin queue of the association with the appropriate SC_C value (refer to section
8.3.5.1).
The host may request secure channel concatenation with the TLS protocol by setting the SC_C field in the
AUTH_Negotiate message to NEWTLSPSK while performing only unidirectional authentication. In this case
the host shall still send a challenge value C2 to the controller and clear the sequence number S2 to 0h to
indicate that controller authentication is not requested.
