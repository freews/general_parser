##### 4.2.4.1 Phase Tag Example

> **Section ID**: 4.2.4.1 | **Page**: 176-177

Figure 108 shows an example of how the Phase Tag bit changes over time as a memory-based controller
completes commands and the host processes those completions. This example shows a Completion
Queue consisting of 6 entries.
At time 0, the host initializes the Completion queue (i.e., clearing the Phase Tag bit to â€˜0â€™ in each completion
queue entry in the completion queue). For the Admin Completion Queue, the host then sets CC.EN to â€˜1â€™
to enable the controller. For an I/O Completion Queue, the host then sends the Create I/O Completion
Queue command. The queue, at this time, is in the Empty condition (refer to section 3.3.1.4).
At time 1, the controller has completed a command, but the host has not consumed that completion queue
entry. As a result of the command completion, the Phase Tag bit in completion queue entry 0 has been
inverted to â€˜1â€™. Since no completion queue entries have been consumed, the Completion Queue Head
pointer still indicates completion queue entry 0. The controller has updated the internal Completion Queue
Tail Pointer to indicate that completion queue slot 1 is the next completion queue slot into which the
controller posts a completion queue entry.
At time 2, the controller has completed 5 additional commands (i.e., 6 commands have been completed)
and the host has consumed 2 of the completion queue entries. As a result of the 5 additional commands
having been completed, the Phase Tag bit has been inverted to â€˜1â€™ in completion queue entry 1 through
completion queue entry 5. As a result of 2 completion queue entries having been consumed, the host has
updated the Completion Queue Head Pointer to indicate that completion queue entry 0 and completion
queue entry 1 have been consumed (i.e., completion queue entry 2 is the next completion queue entry for
the host to consume). The controller has updated the internal Completion Queue Tail Pointer to indicate
that completion queue slot 0 is the next completion queue slot into which the controller posts a completion
queue entry.
At time 3, the controller has completed 1 additional command (i.e., 7 commands have been completed) and
no additional completion queue entries have been consumed by the host (i.e., 2 completion queue entries
have been consumed). As a result of the additional command having been completed, the Phase Tag bit
has been inverted to â€˜0â€™ in completion queue entry 0 (i.e., accounting for the queue wrap condition). The
controller has updated the internal Completion Queue Tail Pointer to indicate that completion queue slot 1
is the next completion queue slot into which the controller posts a completion queue entry. The queue, at
this time, is in the Full condition (refer to section 3.3.1.5).
At time 4, the controller has completed no additional commands (i.e., 7 commands have been completed)
and the host has consumed 2 additional completion queue entries (i.e., 4 completion queue entries have
been consumed). As a result of 2 additional completion queue entries having been consumed, the host has
updated the Completion Queue Head Pointer to indicate that completion queue entry 2 and completion
queue entry 3 have now been consumed (i.e., completion queue entry 4 is the next completion queue entry
for the host to consume). The controller internal Completion Queue Tail Pointer has not changed.
At time 5, the controller has completed 11 commands and the host has consumed 8 of the completion
queue entries. As a result of the 4 additional commands having been completed, the Phase Tag bit has
been inverted to â€˜0â€™ in completion queue entry 1 through completion queue entry 4. As a result of the 4
additional completion queue entries having been consumed, the host has updated the Completion Queue
Head Pointer to indicate that completion queue entry 5 through completion queue entry 1 (i.e., accounting
for the queue wrap condition) have now been consumed (i.e., completion queue entry 2 is the next
completion queue entry for the host to consume). The controller has updated the internal Completion Queue
Tail Pointer to indicate that completion queue slot 5 is the next completion queue slot into which the
controller posts a completion queue entry.
At time 6, the controller has completed 11 commands and the host has consumed all 11 of the completion
queue entries. As a result of no new command completions, there are no changes to the Phase Tag bit
values. As a result of the 3 additional completion queue entries having been consumed, the host has
updated the Completion Queue Head Pointer to indicate that completion queue entry 2 through completion
queue entry 4 have now been consumed (i.e., completion queue slot 5 is the next completion queue slot
from which the host consumes a completion queue entry). The queue, at this time, is in the Empty condition
(refer to section 3.3.1.4).


---
### ðŸ“Š Tables (1)

#### Table 1: Table_4_2_4_1_Phase_Tag_Example
![Table_4_2_4_1_Phase_Tag_Example](../section_images/Table_4_2_4_1_Phase_Tag_Example.png)

| TÂ¹ | Condition | Completion Queue Entry/Slot number | | | | | |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| | | **0** | **1** | **2** | **3** | **4** | **5** |
| 0 | Admin Queue: Host initializes Completion Queue and sets CC.EN to '1'<br>I/O Queue: Host initializes Completion Queue and submits Create I/O Completion Queue command | P(0) (E)<br>HEAD-><br>TAIL-> | P(0) (E) | P(0) (E) | P(0) (E) | P(0) (E) | P(0) (E) |
| 1 | Controller has completed 1 command and the host has consumed 0 completions | P(1) HEAD-><br>TAIL-> | P(0) (E) | P(0) (E) | P(0) (E) | P(0) (E) | P(0) (E) |
| 2 | Controller has completed 6 commands and the host has consumed 2 completions | P(1) (E)<br>TAIL-> | P(1) (E) | P(1) HEAD-> | P(1) (E) | P(1) (E) | P(1) (E) |
| 3 | Controller has completed 7 commands and the host has consumed 2 completions | P(0) (E) | P(1) (E)<br>TAIL-> | P(1) HEAD-> | P(1) (E) | P(1) (E) | P(1) (E) |
| 4 | Controller has completed 7 commands and the host has consumed 4 completions | P(0) (E) | P(1) (E)<br>TAIL-> | P(1) (E) | P(1) (E) | P(1) HEAD-> | P(1) (E) |
| 5 | Controller has completed 11 commands and the host has consumed 8 completions | P(0) (E) | P(0) (E) | P(0) HEAD-> | P(0) (E) | P(0) (E) | P(1) (E)<br>TAIL-> |
| 6 | Controller has completed 11 commands and the host has consumed 11 completions | P(0) (E) | P(0) (E) | P(0) (E) | P(0) (E) | P(0) (E) | P(1) (E)<br>HEAD-><br>TAIL-> |
| | Key: | | | | | | |
| | P(0) = | Phase Tag bit for this completion queue entry is cleared to the value '0'. | | | | | |
| | P(1) = | Phase Tag bit for this completion queue entry is set to the value '1'. | | | | | |
| | (E) = | The Entry/Slot is empty. | | | | | |
| | HEAD-> = | Completion Queue Head Pointer for this completion queue is set to indicate this slot. | | | | | |
| | TAIL-> = | Completion Queue Tail Pointer for this completion queue is used within the controller to indicate this slot. | | | | | |
| | Note: | | | | | | |
| | 1. | T = Time sequence. | | | | | |

