#### 3.5.2 Message-based Controller Initialization (Fabrics)

> **Section ID**: 3.5.2 | **Page**: 130-131

The host selects the NVM subsystem with which to create a host to controller association. The host first
establishes an NVMe Transport connection with the NVM subsystem. Next the host forms an association
with a controller and creates the Admin Queue using the Fabrics Connect command. Finally, the host
configures the controller and creates I/O Queues. Figure 82 is a ladder diagram that describes the queue
creation process for an Admin Queue or an I/O Queue.
The controller initialization steps after an association is established are described below. For determining
capabilities or configuring properties, the host uses the Property Get command and Property Set command,
respectively.
1. NVMe in-band authentication is performed if required (refer to section 8.3.5.2);
2. The host determines the controller capabilities;
3. The host determines the supported I/O Command Sets by checking the state of CAP.CSS and
appropriately initializing CC.CSS as follows:
a. If the CAP.CSS.NOIOCSS bit is set to ‚Äò1‚Äô, then the CC.CSS field should be set to 111b;
b. If the CAP.CSS.IOCSS bit is set to ‚Äò1‚Äô, then the CC.CSS field should be set to 110b; and
c. If the CAP.CSS.IOCSS bit is cleared to ‚Äò0‚Äô and the CAP.CSS.NCSS bit is set to ‚Äò1‚Äô, then the
CC.CSS field should be set to 000b;
4. The host configures controller settings. Specific settings include:
a. The arbitration mechanism should be selected in CC.AMS; and
b. The memory page size should be initialized in CC.MPS;
5. The controller should be enabled by setting CC.EN to ‚Äò1‚Äô;
6. The host should wait for the controller to indicate the controller is ready to process commands. The
controller is ready to process commands when CSTS.RDY is set to ‚Äò1‚Äô;
7. The host determines the configuration of the controller by issuing the Identify command specifying
the Identify Controller data structure (i.e., CNS 01h);
(
)
8. The host determines any I/O Command Set specific configuration information as follows:
a. If the CAP.CSS.IOCSS bit is set to ‚Äò1‚Äô, then the host does the following:
i. Issue the Identify command specifying the Identify I/O Command Set data structure (CNS
1Ch); and
ii. Issue the Set Features command with the I/O Command Set Profile Feature Identifier (FID
19h) specifying the index of the I/O Command Set Combination (refer to Figure 343) to be
enabled;
and
b. For each I/O Command Set that is enabled (Note: the NVM Command Set is enabled if the
CC.CSS field is set to 000b):
i. Issue the Identify command specifying the I/O Command Set specific Active Namespace
ID list (CNS 07h) with the appropriate Command Set Identifier (CSI) value of that I/O
Command Set; and
ii
For each NSID that is returned:
1. If the enabled I/O Command Set is the NVM Command Set or an I/O Command Set
based on the NVM Command Set (e.g., the Zoned Namespace Command Set) issue
the Identify command specifying the Identify Namespace data structure (CNS 00h);
and
2. Issue the Identify command specifying each of the following data structures (refer to
Figure 326: the I/O Command Set specific Identify Namespace data structure, the I/O
Command Set specific Identify Controller data structure, and the I/O Command Set
independent Identify Namespace data structure;
9. The host should determine:
a. the maximum I/O Queue size using CAP.MQES; and
b. the number of I/O Submission Queues and I/O Completion Queues supported using the
response from the Set Features command with the Number of Queues feature identifier;
10. The host should use the Connect command (refer to section 6.3) to create I/O Submission and
Completion Queue pairs; and
;
11. To enable asynchronous notification of optional events, the host should issue a Set Features
command specifying the events to enable. The host may submit one or more Asynchronous Event
Request commands to be notified of asynchronous events as described by section 5.2.2. This step
may be done at any point after the controller signals that the controller is ready (i.e., CSTS.RDY is
set to ‚Äò1‚Äô).
The association may be removed if step 5 (i.e., setting CC.EN to ‚Äò1‚Äô) is not completed within 2 minutes after
establishing the association.


---
### üñºÔ∏è Figures (1)

#### Figure 1: Figure 82: Queue Creation Flow
![Figure 82: Queue Creation Flow](../section_images/Figure_3_5_2_Message_based_Controller_Initialization_Fabrics.png)

