#### 8.1.24 Reservations

> **Section ID**: 8.1.24 | **Page**: 644-646

NVM Express reservations provide capabilities that may be utilized by two or more hosts to coordinate
access to a shared namespace. The protocol and manner in which these capabilities are used is outside
the scope of this specification. Incorrect application of these capabilities may corrupt data and/or otherwise
impair system operation.
Reservation operation after a division event (refer to section 3.2.5.1) is described in section 3.2.5.2.
A reservation on a namespace restricts hosts access to that namespace. If a host submits a command that
uses the Namespace Identifier (NSID) field and that NSID field contains an active NSID, then in the
presence of a reservation on the namespace identified by that NSID where that host lacks sufficient rights,
that command is aborted by the controller with a status code of Reservation Conflict. If a host submits a
command that uses the NSID field and that NSID field is set to FFFFFFFFh, then in the presence of a
reservation on any of the namespaces impacted by that command where that host lacks sufficient rights on
any of the impacted namespaces, that command is aborted by the controller with a status code of
Reservation Conflict. Capabilities are provided that allow recovery from a reservation on a namespace held
by a failing or uncooperative host.
A command is checked for reservation conflict at the time that the controller begins processing that
command. If that reservation conflict check allows the command to be performed (i.e., the host has sufficient
rights for that command with respect to existing reservations, if any), then that command shall not be
subsequently aborted by the controller with a status code of Reservation Conflict (e.g., due to a subsequent
reservation).
A reservation requires an association between a host and a namespace. As shown in Figure 701, each
controller in a multi-path I/O and namespace sharing environment is associated with exactly one host. While
it is possible to construct systems where two or more hosts share a single controller, such usage is outside
the scope of this specification.
A host may be associated with multiple controllers. In Figure 701 host A is associated with two controllers
while hosts B and C are each associated with a single controller. A host should register a non-zero Host
Identifier (refer to section 5.2.26.1.32) with each controller with which that host is associated using a Set
Features command (refer to section 5.2.26) prior to performing any operations associated with reservations.
The Host Identifier allows the NVM subsystem to identify controllers associated with the same host and
preserve reservation properties across these controllers (i.e., a host issued command has the same
reservation rights no matter which controller associated with the host processes the command).
An NVM subsystem may require that the host register a non-zero Host Identifier for a host to use
reservations (e.g., the RHII bit is set to ‘1’ in the CTRATT field of the Identify Controller data structure (refer
to Figure 328)). If the controller does not support reservations with a Host Identifier value of 0h and a
reservation command is received from a host with a Host Identifier value of 0h, then the controller shall
abort that reservation command with a status of Host Identifier Not Initialized.
If an NVM subsystem supports reservations with a Host Identifier value of 0h, and:
then those registrations or reservations remain associated with the Host with a Host Identifier value of 0h
and are not associated with the host with the non-zero Host Identifier.
If the controller does not support reservations with a Host Identifier value of 0h, reservations may have
been established by hosts with non-zero Host Identifiers connected to other controllers, and commands
from a host with a Host Identifier value of 0h that conflict with a reservation (refer to Figure 702 and Figure
703) are aborted by the controller with a status code of Reservation Conflict.
Support for reservations by a namespace or controller is optional. A namespace indicates support for
reservations by reporting a non-zero value in the Reservation Capabilities (RESCAP) field in the Identify
Namespace data structure. A controller indicates support for reservations through the Optional NVM
Command Support (ONCS) field in the Identify Controller data structure (refer to Figure 328). If a host
submits a command associated with reservations (i.e., Reservation Report, Reservation Register,
Reservation Acquire, and Reservation Release):
•
to a controller that does not support reservations; or
•
that impacts a namespace that does not support reservations,
then the command is aborted by the controller with a status code of Invalid Command Opcode.
Controllers that make up an NVM subsystem shall all have the same support for reservations. Although
strongly encouraged, namespaces that make up an NVM subsystem are not all required to have the same
support for reservations. For example, some namespaces within a single controller may support
reservations while others do not, or the supported reservation types may differ among namespaces. If a
controller supports reservations, then the controller shall:
•
Indicate support for reservations by returning a '1' in the Reservations Support (RESERVS) bit of
the Optional NVM Command Support (ONCS) field in the Identify Controller data structure;
•
Support the Reservation Report command (refer to section 7.8), Reservation Register command
(refer to section 7.6), Reservation Acquire command (refer to section 7.5), and Reservation
Release command (refer to section 7.7);
•
Support the Reservation Notification log page;
•
Support the Reservation Log Page Available asynchronous events;
•
Support the Reservation Notification Mask Feature;
•
Support the Host Identifier Feature; and
•
Support the Reservation Persistence Feature.
If a controller supports dispersed namespaces and supports reservations, then the controller supports the
Dispersed Namespace Reservation Support (DISNSRS) bit being set to ‘1’ in the Reservation Report
command, Reservation Register command, Reservation Acquire command, and Reservation Release
command, as described in section 8.1.10.6.
If a namespace supports reservations, then the namespace shall:
•
Report a non-zero value in the Reservation Capabilities (RESCAP) field in the Identify Namespace
data structure;
•
Support Persist Through Power Loss (PTPL) state; and
•
Support sufficient resources to allow a host to successfully register a reservation key on every
controller in the NVM subsystem with access to the shared namespace (i.e., a Reservation Register
command shall never fail due to lack of resources).
NOTE: The behavior of Ignore Existing Key has been changed to improve compatibility with SCSI based
implementations. Conformance to the modified behavior is indicated in the Reservation Capabilities
(RESCAP) field of the Identify Namespace data structure. For the previous definition of Ignore Existing Key
behavior, refer to NVM Express Base Specification, Revision 1.2.1.
