#### 3.5.1 Memory-based Controller Initialization (PCIe)

> **Section ID**: 3.5.1 | **Page**: 128-130

Upon completion of the transport-specific controller initialization steps defined within the relevant NVMe
Transport binding specification, the host should perform the following sequence of actions to initialize the
controller to begin executing commands:
1. The host waits for the controller to indicate that any previous reset is complete by waiting for
CSTS.RDY to become ‘0’;
2. The host configures the Admin Queue by setting the Admin Queue Attributes (AQA), Admin
Submission Queue Base Address (ASQ), and Admin Completion Queue Base Address (ACQ) to
appropriate values;
3. The host determines the supported I/O Command Sets by checking the state of CAP.CSS and
appropriately initializing CC.CSS as follows:
a. If the CAP.CSS.NOIOCSS bit is set to ‘1’, then the CC.CSS field should be set to 111b;
b. If the CAP.CSS.IOCSS bit is set to ‘1’, then the CC.CSS field should be set to 110b; and
c. If the CAP.CSS.IOCSS bit is cleared to ‘0’ and the CAP.CSS.NCSS bit is set to ‘1’, then the
CC.CSS field should be set to 000b;
4. The controller settings should be configured. Specifically:
a. The arbitration mechanism should be selected in CC.AMS; and
b. The memory page size should be initialized in CC.MPS;
5. The host enables the controller by setting CC.EN to ‘1’;
6. The host waits for the controller to indicate that the controller is ready to process commands. The
controller is ready to process commands when CSTS.RDY is set to ‘1’;
7. The host determines the configuration of the controller by issuing the Identify command specifying
the Identify Controller data structure (i.e., CNS 01h);
8. The host determines any I/O Command Set specific configuration information as follows:
a. If the CAP.CSS.IOCSS bit is set to ‘1’, then the host does the following:
i. Issue the Identify command specifying the Identify I/O Command Set data structure (CNS
1Ch); and
ii. Issue the Set Features command with the I/O Command Set Profile Feature Identifier (FID
19h) specifying the index of the I/O Command Set Combination (refer to Figure 343) to be
enabled;
and
b. For each I/O Command Set that is enabled (Note: the NVM Command Set is enabled if the
CC.CSS field is set to 000b):
i. Issue the Identify command specifying the I/O Command Set specific Active Namespace
ID list (CNS 07h) with the appropriate Command Set Identifier (CSI) value of that I/O
Command Set; and
ii. For each NSID that is returned:
1. If the enabled I/O Command Set is the NVM Command Set or an I/O Command Set
based on the NVM Command Set (e.g., the Zoned Namespace Command Set) issue
the Identify command specifying the Identify Namespace data structure (CNS 00h);
and
2. Issue the Identify command specifying each of the following data structures (refer to
Figure 326): the I/O Command Set specific Identify Namespace data structure, the I/O
Command Set specific Identify Controller data structure, and the I/O Command Set
independent Identify Namespace data structure;
9. If the controller implements I/O queues, then the host should determine the number of I/O
Submission Queues and I/O Completion Queues supported using the Set Features command with
the Number of Queues feature identifier. After determining the number of I/O Queues, the NVMe
Transport specific interrupt registers (e.g., MSI and/or MSI-X registers) should be configured;
(
g ,
)
;
10. If the controller implements I/O queues, then the host should allocate the appropriate number of
I/O Completion Queues based on the number required for the system configuration and the number
supported by the controller. The I/O Completion Queues are allocated using the Create I/O
Completion Queue command;
;
11. If the controller implements I/O queues, then the host should allocate the appropriate number of
I/O Submission Queues based on the number required for the system configuration and the number
supported by the controller. The I/O Submission Queues are allocated using the Create I/O
Submission Queue command; and
12. To enable asynchronous notification of optional events, the host should issue a Set Features
command specifying the events to enable. To enable asynchronous notification of events, the host
should submit an appropriate number of Asynchronous Event Request commands. This step may
be done at any point after the controller signals that the controller is ready (i.e., CSTS.RDY is set
to ‘1’).
After performing these steps, the controller shall be ready to process Admin or I/O commands issued by
the host.
For exit of the D3 power state (refer to the PCI Express Base Specification), the initialization steps outlined
should be followed.
