###### 8.3.5.5.4 DH-HMAC-CHAP_Reply Message

> **Section ID**: 8.3.5.5.4 | **Page**: 751-753

The DH-HMAC-CHAP_Reply message is sent from the host to the controller. The host may request
authentication of the controller to enable bidirectional authentication, by including a DH-HMAC-CHAP
challenge value C2 in this message. The challenge value C2 shall be different from the challenge value C1
received in the DH-HMAC-CHAP Challenge message.
The format of the DH-HMAC-CHAP Reply message is shown in Figure 801.
Hash Length (HL): Shall be set to the length in bytes of the selected hash function, as specified in Figure
798.
Challenge Valid: If the host does not require bidirectional authentication or no establishment of a secure
channel after unidirectional authentication is sought (refer to section 8.3.5.5.9), this field shall be cleared to
0h. Otherwise, this field shall be set to 01h.
DH Value Length (DHVLEN): Diffie-Hellman exponential length. This length shall be a multiple of 4. If the
DH group identifier is cleared to 0h (i.e., NULL DH exchange), this field shall be cleared to 0h. Otherwise,
it shall be set to the length in bytes of the DH Value.
Sequence Number (SEQNUM): 32-bit sequence number S2. A random non-zero value shall be used as
the initial value. The sequence number is incremented modulo 232 after each use, except that the value 0h
is skipped (i.e., incrementing the value FFFFFFFFh results in the value 00000001h). The value 0h is used
to indicate that bidirectional authentication is not performed, but a challenge value C2 is carried in order to
generate a pre-shared key (PSK) for subsequent establishment of a secure channel (refer to section
8.3.5.5.9).
Response Value (RVAL): DH-HMAC-CHAP response value R1. The value of R1 is computed using the
hash function H( ) selected by the HashID parameter in the DH-HMAC-CHAP_Challenge message, and
the augmented challenge Ca1. If the NULL DH group has been selected, the augmented challenge Ca1 is
equal to the challenge C1 received from the controller (i.e., Ca1 = C1). If a non-NULL DH group has been
selected, the augmented challenge is computed applying the HMAC function using the hash function H( )
selected by the HashID parameter in the DH-HMAC-CHAP_Challenge message with the hash of the
ephemeral DH key resulting from the combination of the random value y selected by the host with the DH
exponential (i.e., gx mod p) received from the controller as HMAC key (refer to RFC 2104) to the challenge
C1 (i.e., Ca1 = HMAC(H((gx mod p)y mod p), C1) = HMAC(H(gxy mod p), C1)). The value of R1 shall be
computed applying the HMAC function using the hash function H( ) selected by the HashID parameter in
the DH-HMAC-CHAP_Challenge message with key Kh as HMAC key to the concatenation of the
augmented challenge Ca1, the sequence number S1, the transaction identifier T_ID, the secure channel
concatenation indication SC_C sent in the AUTH_Negotiate message, the eight ASCII characters
‚ÄùHostHost‚Äù to indicate the host is computing the reply, the host NQN not including the null terminator, a 00h
byte, and the NVM subsystem NQN not including the null terminator (i.e., R1 = HMAC(Kh, Ca1 || S1 || T_ID
|| SC C || ‚ÄùHostHost‚Äù || NQNh || 00h || NQNc)). Using C language notation:
Challenge Value (CVAL): Shall be set to a random challenge value C2 (refer to section 8.3.5.5.7). Each
challenge value should be unique and unpredictable, since repetition of a challenge value in conjunction
with the same key may reveal information about the key or the correct response to this challenge. The
algorithm for generating the challenge value is outside the scope of this specification. Randomness of the
challenge value is crucial to the security of the protocol (refer to section 8.3.5.5.7). The CVAL length is the
same as the length of the selected hash function (i.e., HL).
DH Value (DHV): Diffie-Hellman exponential. If the DH Value Length is cleared to 0h, this field is not
present. The DH Value shall be set to the value of gy mod p, where y is a random number selected by the
host that shall be at least 256 bits long (refer to section 8.3.5.5.7) and p and g shall have the values indicated
in Figure 799, based on the selected DH group identifier.
Upon receiving a DH-HMAC-CHAP_Reply message, if:
‚Ä¢
the Hash Length (HL) does not match the value specified in Figure 798 for the selected hash
function;
‚Ä¢
DHgID is non-zero and the DH Value Length (DHVLEN) is cleared to 0h; or
‚Ä¢
DHgID is non-zero and the DH Value (DHV) is 0, 1, or p-1;
then the controller shall:
‚Ä¢
reply with an AUTH_Failure1 message having reason code ‚ÄòAuthentication failure‚Äô and reason code
explanation ‚ÄòIncorrect payload‚Äô; and
‚Ä¢
disconnect the NVMe over Fabrics connection.
In addition, the controller shall:
‚Ä¢
check the challenge value C2, if the Challenge Valid field is set to 01h, to verify it is different from
the challenge value C1 the controller previously sent. If C2 is equal to C1, the controller shall:
reply with an AUTH_Failure1 message having reason code ‚ÄòAuthentication failure‚Äô and
reason code explanation ‚ÄòAuthentication failed‚Äô; and
disconnect the NVMe over Fabrics connection;
and
‚Ä¢
verify the response value R1 using the negotiated hash function. If verification of the response value
R1 does not succeed, the controller shall:
reply with an AUTH_Failure1 message having reason code ‚ÄòAuthentication failure‚Äô and
reason code explanation ‚ÄòAuthentication failed‚Äô; and
disconnect the NVMe over Fabrics connection.
If verification of the response value R1 succeeds, the host has been authenticated and the controller shall
continue with a DH-HMAC-CHAP_Success1 message.


---
### üñºÔ∏è Figures (1)

#### Figure 1: Figure 801: DH-HMAC-CHAP_Reply message format
![Figure 801: DH-HMAC-CHAP_Reply message format](../section_images/Figure_8_3_5_5_4_DH_HMAC_CHAP_Reply_Message.png)

