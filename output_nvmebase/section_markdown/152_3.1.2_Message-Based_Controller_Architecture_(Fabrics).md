#### 3.1.2 Message-Based Controller Architecture (Fabrics)

> **Section ID**: 3.1.2 | **Page**: 61-62

Message-based controllers, other than Discovery controllers, may support either the dynamic controller
model or the static controller model. A Discovery controller shall support only the dynamic controller model.
In an NVM subsystem that supports the static controller model, each controller that is allocated to a
particular host may have different state at the time the association is established (e.g., each controller may
have state that is preserved from a prior association). The controllers within such an NVM subsystem are
distinguished by their controller identifier. The host may request a particular controller based on the
Controller ID (refer to the CNTLID field in Figure 580).
In an NVM subsystem that supports the dynamic controller model, each controller is allocated by the NVM
subsystem on demand with no state (e.g., Controller ID, Feature settings) preserved from prior
associations. In this model, all controllers allocated to a specific host have the same state at the time the
association is established, including Feature settings. The initial set of attached namespaces should be the
same for all controllers that are allocated to a specific host and accessed via the same NVM subsystem
port. The initial set of attached namespaces may differ among controllers that are each accessed via a
different NVM subsystem port. Changes to a dynamic controller (e.g., attached namespaces, Feature
settings) after the association is established do not impact other dynamic controllers in that NVM
subsystem.
An association is established between a host and a controller when the host connects to a controller’s
Admin Queue using the Fabrics Connect command (refer to section 6.3). Within the Connect command,
the host specifies the Host NQN, NVM Subsystem NQN, Host Identifier, and may request a specific
Controller ID (e.g., the static controller model is being used) or may request a connection to any available
controller (e.g., the dynamic controller model is being used). A controller has only one association at a time.
While an association exists between a host and a controller, only that host may establish connections with
I/O Queues of that controller. To establish a new connection with I/O Queues of that controller, the host
sends subsequent Connect commands using the same NVM subsystem port, NVMe Transport type, and
NVMe Transport address and specifies the:
•
same Host NQN;
•
same NVM Subsystem NQN;
•
same Controller ID; and
•
either the:
o
same Host Identifier; or
o
a Host Identifier value of 0h, if supported (refer to section 5.2.12.3.3).
An association between a host and controller is terminated if:
•
the controller is shutdown as described in section 3.6.2;
•
a Controller Level Reset occurs;
•
the NVMe Transport connection is lost between the host and controller for the Admin Queue; or
•
an NVMe Transport connection is lost between the host and controller for any I/O Queue and the
host or controller does not support individual I/O Queue deletion (refer to section 3.3.2.4).
There is no explicit NVMe command that breaks the NVMe Transport association between a host and
controller. The Disconnect command (refer to section 6.4) provides a method to delete an I/O Queue (refer
to section 3.3.2.4). While a controller is associated with a host, that controller is busy, and no other
associations may be made with that controller.
To use the dynamic controller model, the host specifies a controller identifier of FFFFh when using the
Fabrics Connect command (refer to section 6.3) to establish an association with an NVM subsystem.
When using the static controller model with a fabric connected controller, the state that persists across
associations is any state that persists across a Controller Level Reset. Additionally, different controllers
may present different Feature settings or namespace attachments to the same host. The NVM subsystem
may allocate particular controllers to specific hosts.
While allocation of static controllers to hosts are expected to be durable (so that hosts can expect to form
associations to the same controllers repeatedly (e.g., after each host reboot)), the NVM subsystem may
remove the host allocation of a controller that is not in use at any time for implementation specific reasons
(e.g., controller resource reclamation, subsystem reconfiguration).
