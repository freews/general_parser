###### 5.2.17.1.3 Set Controller State (Management Operation 2h)

> **Section ID**: 5.2.17.1.3 | **Page**: 405-411

The Set Controller State management operation of the Migration Send command allows the host to set the
state of the controller specified by the Controller Identifier (CNTLID) field in Command Dword 11 (refer to
Figure 370).
The data buffer contains the Controller State data structure specified in Figure 374 which specifies the state
to be set in the specified controller.
To set the controller state of the specified controller, the specified controller is required to be in one or more
of these conditions:
‚Ä¢
Suspended (refer to section 5.2.17.1.1);
‚Ä¢
enabled (i.e., CC.EN bit is set to ‚Äò1‚Äô); or
‚Ä¢
offline, if that specified controller is a secondary controller.
If the specified controller is not in one of these conditions, then the controller processing the command shall
abort the command with a status code of Invalid Controller Identifier.
The host may submit one or more Migration Send commands to transfer the controller state. If more than
one Migration Send command is submitted to transfer the controller state, then:
‚Ä¢
The host first submits a Migration Send command with:
the Select field set to Set Controller State (i.e., 2h);
the Sequence Indicator (SEQIND) field (refer to Figure 369) set to 01b; and
the Controller Identifier field set to the controller whose state is being set,
to specify to the controller that the command is the first of a sequence of Migration Send commands
of controller state data being transferred.
‚Ä¢
The host may submit Migration Send commands with:
the Select field set to Set Controller State (i.e., 2h);
the SEQIND field cleared to 00b; and
the Controller Identifier field set to the controller whose state is being set,
to specify to the controller that the command is not the last of the sequence of Migration Send
commands of controller state data being transferred, if any.
‚Ä¢
The host is required to wait for the completion queue entries to be posted for the previous submitted
Migration Send commands in the sequence of Migration Send commands.
‚Ä¢
Finally, the host submits the last Migration Send command with:
the Select field set to Set Controller State (i.e., 2h);
the SEQIND field set to 10b; and
the Controller Identifier field set to the controller whose state is being set,
to specify to the controller that this is the last command of the sequence of Migration Send
commands of the controller state data being transferred. This last Migration Send command may
or may not have the Number of Dwords (NUMD) field cleared to 0h.
If a sequence of Migration Send commands of the controller state data being transferred and the controller
processes a Migration Send command with:
‚Ä¢
the Select field set to Set Controller State (i.e., 2h);
‚Ä¢
the Sequence Indicator (SEQIND) field (refer to Figure 369) set to 01b; and
‚Ä¢
the Controller Identifier field set to the controller whose state is being set,
then, the command is specifying a new sequence of Migration Send commands of the controller state data
is being transferred and the previous sequence of Migration Send commands of the controller state data is
discarded.
If a sequence of Migration Send commands of the controller state data is not being transferred to the
specified controller and the controller processes a Migration Send command with the Sequence Indicator
(SEQIND) field (refer to Figure 369) not set to 01b, clearer to 0b; the controller shall abort that command
with a status code of Command Sequence Error.
If a single Migration Send command is submitted to transfer the entire controller state, then the host submits
a Migration Send command with the SEQIND field set to 11b.
If the host specifies an offset (i.e., the CSLO field and the CSUO field) that is greater than the size of the
Controller State data, then the controller shall abort the command with a status code of Invalid Field in
Command.
If the CSVI field (refer to Figure 370) specifies a non-zero index that is not defined by the Supported
Controller State Formats data structure (refer to Figure 345), then the controller shall abort the command
with a status code of Invalid Field in Command.
If the CSVI field (refer to Figure 370) is cleared to 0h and the NVMe Controller State Size field is non-zero
then the controller shall abort the command with a status code of Invalid Field in Command.
If the CSUUIDI field (refer to Figure 370) specifies a non-zero index that is not defined by the Supported
Controller State Formats data structure, then the controller shall abort the command with a status code of
Invalid Field in Command.
If the NVMe Controller State field exists (i.e., the NVMECSS field is non-zero) and any I/O Submission
Queue or I/O Completion Queue exists in the controller specified by the Controller Identifier (CNTLID) field,
then the controller shall abort the command with a status code of Invalid Field in Command.
Figure 375 defines the NVMe Controller State data structure that identifies the state of the all the I/O
Submission Queues and I/O Completion Queues for a controller. Any controller state defined by this
specification that is not included in the NVMe Controller State data structure is either included in the Vendor
Specific Data field in the Controller State data structure (refer to Figure 374) or is obtained in a vendor
specific manner.
The I/O Submission Queue list shall be listed in ascending order by I/O Submission Queue Identifier.
The I/O Completion Queue list shall be listed in ascending order by I/O Completion Queue Identifier.
If the CSVI field (refer to Figure 370) is cleared to 0h and the NVMe Controller State Size field (refer to
Figure 374) is not cleared to 0h, then the controller shall abort the command with a status code of Invalid
Field in Command.
If the CSUUIDI field (refer to Figure 370) is cleared to 0h and the Vendor Specific Size field (refer to Figure
374) is not cleared to 0h, then the controller shall abort the command with a status code of Invalid Field in
Command.
If the CSVI field (refer to Figure 370) is cleared to 0h and the CSUUIDI field (refer to Figure 370) is cleared
to 0h, then the controller shall abort the command with a status code of Invalid Field in Command.
If the Migration Send command for this management operation specifies the SEQIND field set to 10b and
that command completes successfully, then the controller state shall be verified and committed to the
specified controller which includes:
‚Ä¢
Creating any I/O Submission Queues and I/O Completion Queues specified by the NVMe
Controller State field; and
‚Ä¢
setting the queue state for each I/O Submission Queues and I/O Completion Queues specified by
the NVMe Controller State field.
If any Migration Send command for this management operation is not successful, then the host should
attempt to re-transfer the entire controller state data so that any existing controller state is overwritten with
the desired controller state.


---
### üñºÔ∏è Figures (8)

#### Figure 1: Figure 369: Set Controller State ‚Äì Management Operation Specific Field
![Figure 369: Set Controller State ‚Äì Management Operation Specific Field](../section_images/Figure_5_2_17_1_3_Set_Controller_State_Management_Operation_2h_1.png)


#### Figure 2: Figure 370: Set Controller State ‚Äì Command Dword 11
![Figure 370: Set Controller State ‚Äì Command Dword 11](../section_images/Figure_5_2_17_1_3_Set_Controller_State_Management_Operation_2h_2.png)


#### Figure 3: Figure 371: Set Controller State ‚Äì Command Dword 12
![Figure 371: Set Controller State ‚Äì Command Dword 12](../section_images/Figure_5_2_17_1_3_Set_Controller_State_Management_Operation_2h_3.png)


#### Figure 4: Figure 372: Set Controller State ‚Äì Command Dword 13
![Figure 372: Set Controller State ‚Äì Command Dword 13](../section_images/Figure_5_2_17_1_3_Set_Controller_State_Management_Operation_2h_4.png)


#### Figure 5: Figure 373: Set Controller State ‚Äì Command Dword 15
![Figure 373: Set Controller State ‚Äì Command Dword 15](../section_images/Figure_5_2_17_1_3_Set_Controller_State_Management_Operation_2h_5.png)


#### Figure 6: Figure 375 defines the NVMe Controller State data structure that identifies the state of the all the I/O
Submission Queues and I/O Completion Queues for a controller. Any controller state defined by this
specification that is not included in the NVMe Controller State data structure is either included in the Vendor
Specific Data field in the Controller State data structure (refer to Figure 374) or is obtained in a vendor
specific manner.
![Figure 375 defines the NVMe Controller State data structure that identifies the state of the all the I/O
Submission Queues and I/O Completion Queues for a controller. Any controller state defined by this
specification that is not included in the NVMe Controller State data structure is either included in the Vendor
Specific Data field in the Controller State data structure (refer to Figure 374) or is obtained in a vendor
specific manner.](../section_images/Figure_5_2_17_1_3_Set_Controller_State_Management_Operation_2h_6.png)


#### Figure 7: Figure 375: NVMe Controller State Data Structure
![Figure 375: NVMe Controller State Data Structure](../section_images/Figure_5_2_17_1_3_Set_Controller_State_Management_Operation_2h_7.png)


#### Figure 8: Figure 376: I/O Submission Queue State Data Structure
![Figure 376: I/O Submission Queue State Data Structure](../section_images/Figure_5_2_17_1_3_Set_Controller_State_Management_Operation_2h_8.png)

